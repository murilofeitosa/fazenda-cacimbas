<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fazenda Cacimbas - Sistema Pl√∫vio Pro</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary-blue: #0d6efd;
            --success-green: #198754;
            --warning-yellow: #ffc107;
            --danger-red: #dc3545;
            --bg-light: #f0f2f5;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --glass-bg: rgba(255, 255, 255, 0.95);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        /* Header Moderno */
        .header-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .logo-img {
            width: 60px;
            height: 60px;
            margin-right: 1rem;
            filter: brightness(0) invert(1);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Cards com Glassmorphism */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        
        /* KPIs Melhorados */
        .kpi-card {
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-blue), #0a58ca);
        }
        
        .kpi-card.current-season::before {
            background: linear-gradient(180deg, var(--success-green), #146c43);
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-blue), #0a58ca);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0.5rem 0;
        }
        
        .kpi-card.current-season .kpi-value {
            background: linear-gradient(135deg, var(--success-green), #146c43);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .kpi-trend {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            display: inline-block;
        }
        
        .trend-up {
            background: rgba(25, 135, 84, 0.1);
            color: var(--success-green);
        }
        
        .trend-down {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger-red);
        }
        
        .trend-neutral {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }
        
        /* Dashboard Executivo */
        .executive-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);
        }
        
        .insight-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 1rem;
        }
        
        .insight-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        /* Alertas */
        .alert-box {
            border-left: 4px solid;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .alert-success {
            background: rgba(25, 135, 84, 0.1);
            border-left-color: var(--success-green);
            color: var(--success-green);
        }
        
        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            border-left-color: var(--warning-yellow);
            color: #997404;
        }
        
        .alert-danger {
            background: rgba(220, 53, 69, 0.1);
            border-left-color: var(--danger-red);
            color: var(--danger-red);
        }
        
        /* Filtros Interativos */
        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
        }
        
        .filter-btn {
            padding: 0.6rem 1.2rem;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            background: white;
            margin: 0.3rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .filter-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }
        
        .filter-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }
        
        /* Mapa de Calor Estilo GitHub */
        .heatmap-github {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            overflow-x: auto;
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(53, 1fr);
            gap: 3px;
            margin-top: 1rem;
        }
        
        .heatmap-cell {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: #ebedf0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.5);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }
        
        .heatmap-cell[data-level="0"] { background: #ebedf0; }
        .heatmap-cell[data-level="1"] { background: #9be9a8; }
        .heatmap-cell[data-level="2"] { background: #40c463; }
        .heatmap-cell[data-level="3"] { background: #30a14e; }
        .heatmap-cell[data-level="4"] { background: #216e39; }
        
        /* Comparativo de Safras */
        .comparison-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .comparison-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .comparison-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-blue), var(--success-green));
        }
        
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 1rem auto;
        }
        
        /* Estat√≠sticas Avan√ßadas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background: rgba(13, 110, 253, 0.05);
            border-radius: 10px;
            border: 2px solid rgba(13, 110, 253, 0.1);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-blue);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.3rem;
        }
        
        /* Tabela Melhorada */
        .table-modern {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .table-modern thead th {
            background: linear-gradient(135deg, var(--primary-blue), #0a58ca);
            color: white;
            font-weight: 600;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .table-modern tbody tr {
            transition: all 0.2s;
        }
        
        .table-modern tbody tr:hover {
            background: rgba(13, 110, 253, 0.05);
            transform: scale(1.01);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-title {
                font-size: 1.3rem;
            }
            
            .kpi-value {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .comparison-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Anima√ß√µes */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in-up {
            animation: fadeInUp 0.6s ease;
        }
        
        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Chart Container */
        .chart-container-wrapper {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }
        
        .chart-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--bg-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chart-title i {
            color: var(--primary-blue);
            margin-right: 0.6rem;
        }
        
        .chart-info {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 400;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-section">
        <div class="container">
            <div class="d-flex align-items-center justify-content-between flex-wrap">
                <div class="d-flex align-items-center">
                    <img src="https://cdn-icons-png.flaticon.com/512/2830/2830227.png" alt="Logo" class="logo-img">
                    <div>
                        <h1 class="header-title">Fazenda Cacimbas - Sistema Pl√∫vio Pro</h1>
                        <p class="mb-0 opacity-75" id="currentDate" style="font-size: 0.9rem;"></p>
                    </div>
                </div>
                <div class="text-end">
                    <i class="fas fa-cloud-showers-heavy fa-3x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <!-- Dashboard Executivo -->
        <div class="executive-summary fade-in-up">
            <h2 class="mb-3"><i class="fas fa-brain me-2"></i>Resumo Executivo - An√°lise Inteligente</h2>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="insight-card">
                        <div class="insight-icon">üìä</div>
                        <h5 id="statusSafra">Calculando...</h5>
                        <p class="mb-0 small" id="statusDesc"></p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="insight-card">
                        <div class="insight-icon">‚ö°</div>
                        <h5 id="ultimaChuva">Calculando...</h5>
                        <p class="mb-0 small" id="ultimaChuvaDesc"></p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="insight-card">
                        <div class="insight-icon">üéØ</div>
                        <h5 id="projecao">Calculando...</h5>
                        <p class="mb-0 small" id="projecaoDesc"></p>
                    </div>
                </div>
            </div>
            <div id="alertasContainer"></div>
        </div>

        <!-- Filtros -->
        <div class="filter-section">
            <h5 class="mb-3"><i class="fas fa-filter me-2"></i>Filtrar Visualiza√ß√£o</h5>
            <div class="d-flex flex-wrap">
                <button class="filter-btn active" data-filter="all">Todos os Invernos</button>
                <button class="filter-btn" data-filter="2024">Inverno 2024</button>
                <button class="filter-btn" data-filter="2025">Inverno 2025</button>
                <button class="filter-btn" data-filter="2026">Inverno 2026</button>
                <button class="filter-btn" data-filter="compare">Comparar Safras</button>
            </div>
        </div>

        <!-- KPIs -->
        <div class="row mb-4" id="kpiContainer">
            <!-- KPIs gerados dinamicamente -->
        </div>

        <!-- Comparativo de Safras -->
        <div class="glass-card mb-4" id="comparativoSection" style="display: none;">
            <h3 class="chart-title">
                <span><i class="fas fa-balance-scale"></i>Comparativo Entre Safras</span>
            </h3>
            <div class="comparison-container" id="comparisonContainer"></div>
        </div>

        <!-- Estat√≠sticas Avan√ßadas -->
        <div class="glass-card mb-4">
            <h3 class="chart-title">
                <span><i class="fas fa-chart-pie"></i>Estat√≠sticas Detalhadas - Inverno Atual</span>
            </h3>
            <div class="stats-grid" id="statsContainer"></div>
        </div>

        <!-- Gr√°fico Comparativo Multi-Safra -->
        <div class="chart-container-wrapper">
            <h3 class="chart-title">
                <span><i class="fas fa-chart-line"></i>Evolu√ß√£o Comparativa - Todas as Safras</span>
                <span class="chart-info">Acumulado por dia desde in√≠cio</span>
            </h3>
            <canvas id="multiSeasonChart"></canvas>
        </div>

        <!-- Gr√°fico de Distribui√ß√£o -->
        <div class="chart-container-wrapper">
            <h3 class="chart-title">
                <span><i class="fas fa-chart-bar"></i>Distribui√ß√£o de Intensidade</span>
                <span class="chart-info">Frequ√™ncia por faixa de precipita√ß√£o</span>
            </h3>
            <canvas id="distributionChart"></canvas>
        </div>

        <div class="row">
            <!-- An√°lise de Intervalos -->
            <div class="col-lg-6 mb-4">
                <div class="chart-container-wrapper">
                    <h3 class="chart-title">
                        <span><i class="fas fa-clock"></i>Intervalos entre Chuvas</span>
                    </h3>
                    <canvas id="intervalsChart"></canvas>
                </div>
            </div>

            <!-- Radar Comparativo -->
            <div class="col-lg-6 mb-4">
                <div class="chart-container-wrapper">
                    <h3 class="chart-title">
                        <span><i class="fas fa-chart-area"></i>Padr√£o Mensal Comparativo</span>
                    </h3>
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Mapa de Calor Estilo GitHub -->
        <div class="glass-card mb-4">
            <h3 class="chart-title">
                <span><i class="fas fa-calendar-alt"></i>Calend√°rio de Chuvas - √öltimos 12 Meses</span>
            </h3>
            <div class="heatmap-github" id="githubHeatmap"></div>
        </div>

        <!-- Tabela Detalhada -->
        <div class="glass-card">
            <h3 class="chart-title">
                <span><i class="fas fa-table"></i>Registro Completo</span>
                <span class="chart-info"><span id="recordCount">0</span> eventos registrados</span>
            </h3>
            <div style="max-height: 600px; overflow-y: auto;">
                <table class="table table-modern table-hover">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Precipita√ß√£o</th>
                            <th>Intensidade</th>
                            <th>Temporada</th>
                            <th>Intervalo</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // ===== DADOS BRUTOS =====
        const rawData = [
            // INVERNO 2024
            { date: '2023-11-06', value: 6, season: '2024' },
            { date: '2023-11-28', value: 8, season: '2024' },
            { date: '2023-12-18', value: 9, season: '2024' },
            { date: '2023-12-20', value: 48, season: '2024' },
            { date: '2023-12-21', value: 10, season: '2024' },
            { date: '2024-01-12', value: 20, season: '2024' },
            { date: '2024-02-09', value: 9, season: '2024' },
            { date: '2024-02-11', value: 20, season: '2024' },
            { date: '2024-02-13', value: 11, season: '2024' },
            { date: '2024-02-18', value: 39, season: '2024' },
            { date: '2024-02-21', value: 59, season: '2024' },
            { date: '2024-02-27', value: 28, season: '2024' },
            { date: '2024-02-28', value: 30, season: '2024' },
            { date: '2024-03-01', value: 8, season: '2024' },
            { date: '2024-03-04', value: 8, season: '2024' },
            { date: '2024-03-05', value: 16, season: '2024' },
            { date: '2024-03-13', value: 19, season: '2024' },
            { date: '2024-03-27', value: 19, season: '2024' },
            { date: '2024-03-30', value: 21, season: '2024' },
            { date: '2024-03-31', value: 110, season: '2024' },
            { date: '2024-04-02', value: 11, season: '2024' },
            { date: '2024-04-03', value: 5, season: '2024' },
            { date: '2024-04-10', value: 32, season: '2024' },
            { date: '2024-04-11', value: 2, season: '2024' },
            { date: '2024-04-12', value: 14, season: '2024' },
            { date: '2024-04-14', value: 3, season: '2024' },
            { date: '2024-04-15', value: 11, season: '2024' },
            { date: '2024-04-16', value: 6, season: '2024' },
            { date: '2024-04-20', value: 5, season: '2024' },
            { date: '2024-04-21', value: 23, season: '2024' },
            { date: '2024-04-22', value: 11, season: '2024' },
            
            // INVERNO 2025
            { date: '2024-12-03', value: 40, season: '2025' },
            { date: '2025-01-13', value: 14, season: '2025' },
            { date: '2025-01-14', value: 105, season: '2025' },
            { date: '2025-01-15', value: 34, season: '2025' },
            { date: '2025-01-20', value: 95, season: '2025' },
            { date: '2025-01-23', value: 10, season: '2025' },
            { date: '2025-02-17', value: 11, season: '2025' },
            { date: '2025-02-19', value: 22, season: '2025' },
            { date: '2025-02-24', value: 34, season: '2025' },
            { date: '2025-02-28', value: 50, season: '2025' },
            { date: '2025-03-01', value: 56, season: '2025' },
            { date: '2025-03-03', value: 10, season: '2025' },
            { date: '2025-03-04', value: 30, season: '2025' },
            { date: '2025-03-06', value: 6, season: '2025' },
            { date: '2025-03-07', value: 100, season: '2025' },
            { date: '2025-03-08', value: 24, season: '2025' },
            { date: '2025-03-11', value: 5, season: '2025' },
            { date: '2025-03-17', value: 9, season: '2025' },
            { date: '2025-03-18', value: 77, season: '2025' },
            { date: '2025-03-22', value: 9, season: '2025' },
            { date: '2025-03-28', value: 40, season: '2025' },
            { date: '2025-04-02', value: 10, season: '2025' },
            { date: '2025-04-22', value: 19, season: '2025' },
            { date: '2025-05-05', value: 11, season: '2025' },
            { date: '2025-05-10', value: 10, season: '2025' },
            { date: '2025-05-21', value: 9, season: '2025' },
            
            // INVERNO 2026
            { date: '2025-10-21', value: 20, season: '2026' },
            { date: '2025-12-22', value: 55, season: '2026' },
            { date: '2025-12-23', value: 18, season: '2026' },
            { date: '2026-01-21', value: 7, season: '2026' },
            { date: '2026-01-27', value: 59, season: '2026' },
            { date: '2026-01-29', value: 40, season: '2026' },
            { date: '2026-02-05', value: 20, season: '2026' },
            { date: '2026-02-07', value: 8, season: '2026' }
        ];

        // ===== PROCESSAMENTO DE DADOS =====
        const mesesNomes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        
        const dadosChuva = rawData.map(item => ({
            data: item.date,
            chuva_mm: item.value,
            temporada: `Inverno ${item.season}`,
            season: item.season
        })).sort((a, b) => new Date(b.data) - new Date(a.data));
        
        const hoje = new Date();
        document.getElementById('currentDate').textContent = hoje.toLocaleDateString('pt-BR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Calcular estat√≠sticas por temporada
        const estatisticas = {};
        dadosChuva.forEach(item => {
            if (!estatisticas[item.temporada]) {
                estatisticas[item.temporada] = {
                    total: 0,
                    count: 0,
                    max: 0,
                    min: Infinity,
                    valores: [],
                    datas: []
                };
            }
            const stat = estatisticas[item.temporada];
            stat.total += item.chuva_mm;
            stat.count++;
            stat.max = Math.max(stat.max, item.chuva_mm);
            stat.min = Math.min(stat.min, item.chuva_mm);
            stat.valores.push(item.chuva_mm);
            stat.datas.push(new Date(item.data));
        });

        // Calcular m√©dia, mediana, desvio padr√£o
        Object.keys(estatisticas).forEach(temp => {
            const stat = estatisticas[temp];
            stat.media = stat.total / stat.count;
            
            stat.valores.sort((a, b) => a - b);
            stat.mediana = stat.count % 2 === 0 
                ? (stat.valores[stat.count/2 - 1] + stat.valores[stat.count/2]) / 2
                : stat.valores[Math.floor(stat.count/2)];
            
            const variancia = stat.valores.reduce((acc, val) => acc + Math.pow(val - stat.media, 2), 0) / stat.count;
            stat.desvioPadrao = Math.sqrt(variancia);
            
            // Calcular intervalos entre chuvas
            stat.intervalos = [];
            for (let i = 0; i < stat.datas.length - 1; i++) {
                const diff = Math.abs(stat.datas[i] - stat.datas[i + 1]);
                stat.intervalos.push(Math.floor(diff / (1000 * 60 * 60 * 24)));
            }
            stat.intervaloMedio = stat.intervalos.length > 0 
                ? stat.intervalos.reduce((a, b) => a + b, 0) / stat.intervalos.length 
                : 0;
        });

        const temporadaAtual = dadosChuva[0].temporada;

        // ===== DASHBOARD EXECUTIVO =====
        function gerarDashboardExecutivo() {
            const statAtual = estatisticas[temporadaAtual];
            const ultimaData = new Date(dadosChuva[0].data);
            const diasDesdeUltima = Math.floor((hoje - ultimaData) / (1000 * 60 * 60 * 24));
            
            // Status da Safra
            const temporadas = Object.keys(estatisticas).sort();
            const indiceAtual = temporadas.indexOf(temporadaAtual);
            let statusTexto, statusDesc, statusClass;
            
            if (indiceAtual > 0) {
                const tempAnterior = temporadas[indiceAtual - 1];
                const percDif = ((statAtual.total - estatisticas[tempAnterior].total) / estatisticas[tempAnterior].total) * 100;
                
                if (percDif > 10) {
                    statusTexto = `+${percDif.toFixed(0)}% Acima`;
                    statusDesc = `${percDif.toFixed(1)}% superior ao inverno anterior`;
                    statusClass = 'success';
                } else if (percDif < -10) {
                    statusTexto = `${percDif.toFixed(0)}% Abaixo`;
                    statusDesc = `Aten√ß√£o: ${Math.abs(percDif).toFixed(1)}% inferior ao inverno anterior`;
                    statusClass = 'warning';
                } else {
                    statusTexto = 'Dentro da M√©dia';
                    statusDesc = 'Precipita√ß√£o similar ao inverno anterior';
                    statusClass = 'neutral';
                }
            } else {
                statusTexto = 'Primeira Safra';
                statusDesc = 'Sem hist√≥rico para compara√ß√£o';
                statusClass = 'neutral';
            }
            
            document.getElementById('statusSafra').textContent = statusTexto;
            document.getElementById('statusDesc').textContent = statusDesc;
            
            // √öltima Chuva
            document.getElementById('ultimaChuva').textContent = `H√° ${diasDesdeUltima} dias`;
            document.getElementById('ultimaChuvaDesc').textContent = `√öltima: ${dadosChuva[0].chuva_mm}mm em ${ultimaData.toLocaleDateString('pt-BR')}`;
            
            // Proje√ß√£o
            const diasDecorridos = Math.floor((hoje - new Date(dadosChuva[dadosChuva.length - 1].data)) / (1000 * 60 * 60 * 24));
            const taxaDiaria = statAtual.total / Math.max(diasDecorridos, 1);
            const projecao180 = taxaDiaria * 180;
            
            document.getElementById('projecao').textContent = `${projecao180.toFixed(0)}mm`;
            document.getElementById('projecaoDesc').textContent = `Proje√ß√£o para 180 dias (${taxaDiaria.toFixed(2)}mm/dia)`;
            
            // Alertas
            const alertasContainer = document.getElementById('alertasContainer');
            alertasContainer.innerHTML = '';
            
            // Alerta de estiagem
            if (diasDesdeUltima > 15) {
                alertasContainer.innerHTML += `
                    <div class="alert-box alert-warning">
                        <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong>Alerta de Estiagem:</strong> ${diasDesdeUltima} dias sem precipita√ß√£o significativa
                        </div>
                    </div>
                `;
            }
            
            // Alerta de chuva forte recente
            if (dadosChuva[0].chuva_mm > 50 && diasDesdeUltima <= 3) {
                alertasContainer.innerHTML += `
                    <div class="alert-box alert-success">
                        <i class="fas fa-check-circle me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong>Chuva Significativa:</strong> ${dadosChuva[0].chuva_mm}mm registrados recentemente
                        </div>
                    </div>
                `;
            }
            
            // Alerta de performance vs m√©dia
            const mediaHistorica = Object.values(estatisticas).reduce((acc, s) => acc + s.media, 0) / Object.keys(estatisticas).length;
            if (statAtual.media < mediaHistorica * 0.7) {
                alertasContainer.innerHTML += `
                    <div class="alert-box alert-danger">
                        <i class="fas fa-times-circle me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong>Performance Baixa:</strong> M√©dia atual ${statAtual.media.toFixed(1)}mm est√° ${((1 - statAtual.media/mediaHistorica) * 100).toFixed(0)}% abaixo do hist√≥rico
                        </div>
                    </div>
                `;
            }
        }

        // ===== KPIs =====
        function gerarKPIs() {
            const container = document.getElementById('kpiContainer');
            container.innerHTML = '';
            const temporadas = Object.keys(estatisticas).sort().reverse();
            
            temporadas.forEach((temp, idx) => {
                const stat = estatisticas[temp];
                const isAtual = temp === temporadaAtual;
                
                let trendClass = 'trend-neutral';
                let trendIcon = 'fa-minus';
                let trendText = 'N/A';
                
                if (idx < temporadas.length - 1) {
                    const anterior = estatisticas[temporadas[idx + 1]];
                    const diff = ((stat.total - anterior.total) / anterior.total) * 100;
                    if (diff > 5) {
                        trendClass = 'trend-up';
                        trendIcon = 'fa-arrow-up';
                        trendText = `+${diff.toFixed(0)}%`;
                    } else if (diff < -5) {
                        trendClass = 'trend-down';
                        trendIcon = 'fa-arrow-down';
                        trendText = `${diff.toFixed(0)}%`;
                    } else {
                        trendText = `${diff > 0 ? '+' : ''}${diff.toFixed(0)}%`;
                    }
                }
                
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-3 fade-in-up';
                col.style.animationDelay = `${idx * 0.1}s`;
                
                col.innerHTML = `
                    <div class="glass-card kpi-card ${isAtual ? 'current-season' : ''}">
                        <div class="kpi-header">
                            <div class="kpi-label">
                                ${temp}
                                ${isAtual ? '<i class="fas fa-star ms-2" style="color: var(--success-green);"></i>' : ''}
                            </div>
                            <span class="kpi-trend ${trendClass}">
                                <i class="fas ${trendIcon} me-1"></i>${trendText}
                            </span>
                        </div>
                        <div class="kpi-value">${stat.total.toFixed(0)} <small style="font-size: 1rem;">mm</small></div>
                        <div class="text-muted small">
                            <div class="mb-1">
                                <i class="fas fa-chart-bar me-2"></i>M√©dia: <strong>${stat.media.toFixed(1)}mm</strong> | 
                                M√°x: <strong>${stat.max}mm</strong>
                            </div>
                            <div>
                                <i class="fas fa-droplet me-2"></i><strong>${stat.count}</strong> eventos | 
                                Intervalo: <strong>${stat.intervaloMedio.toFixed(0)}</strong> dias
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(col);
            });
        }

        // ===== ESTAT√çSTICAS DETALHADAS =====
        function gerarEstatisticas() {
            const container = document.getElementById('statsContainer');
            const stat = estatisticas[temporadaAtual];
            
            const stats = [
                { label: 'Total Acumulado', value: `${stat.total.toFixed(0)}mm`, icon: 'fa-tint' },
                { label: 'M√©dia por Evento', value: `${stat.media.toFixed(1)}mm`, icon: 'fa-chart-line' },
                { label: 'Mediana', value: `${stat.mediana.toFixed(1)}mm`, icon: 'fa-chart-bar' },
                { label: 'Desvio Padr√£o', value: `${stat.desvioPadrao.toFixed(1)}mm`, icon: 'fa-wave-square' },
                { label: 'M√°ximo', value: `${stat.max}mm`, icon: 'fa-arrow-up' },
                { label: 'M√≠nimo', value: `${stat.min}mm`, icon: 'fa-arrow-down' },
                { label: 'Total de Eventos', value: stat.count, icon: 'fa-calendar-check' },
                { label: 'Intervalo M√©dio', value: `${stat.intervaloMedio.toFixed(0)} dias`, icon: 'fa-clock' }
            ];
            
            container.innerHTML = stats.map(s => `
                <div class="stat-item fade-in-up">
                    <i class="fas ${s.icon} mb-2" style="font-size: 1.5rem; color: var(--primary-blue);"></i>
                    <div class="stat-value">${s.value}</div>
                    <div class="stat-label">${s.label}</div>
                </div>
            `).join('');
        }

        // ===== GR√ÅFICO MULTI-SAFRA =====
        function criarGraficoMultiSafra() {
            const ctx = document.getElementById('multiSeasonChart').getContext('2d');
            
            const datasets = [];
            const cores = [
                { bg: 'rgba(255, 99, 132, 0.2)', border: 'rgba(255, 99, 132, 1)' },
                { bg: 'rgba(54, 162, 235, 0.2)', border: 'rgba(54, 162, 235, 1)' },
                { bg: 'rgba(75, 192, 192, 0.2)', border: 'rgba(75, 192, 192, 1)' }
            ];
            
            Object.keys(estatisticas).sort().forEach((temp, idx) => {
                const dados = dadosChuva
                    .filter(d => d.temporada === temp)
                    .sort((a, b) => new Date(a.data) - new Date(b.data));
                
                let acumulado = 0;
                const acumulados = dados.map(d => {
                    acumulado += d.chuva_mm;
                    return acumulado;
                });
                
                datasets.push({
                    label: temp,
                    data: acumulados,
                    borderColor: cores[idx % cores.length].border,
                    backgroundColor: cores[idx % cores.length].bg,
                    borderWidth: 3,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 4,
                    pointHoverRadius: 7
                });
            });
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: Math.max(...datasets.map(d => d.data.length))}, (_, i) => `Evento ${i + 1}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 13, weight: '600' },
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Acumulado (mm)',
                                font: { size: 12, weight: 'bold' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Sequ√™ncia de Eventos',
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        // ===== GR√ÅFICO DE DISTRIBUI√á√ÉO =====
        function criarGraficoDistribuicao() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            const faixas = [
                { label: '0-10mm', min: 0, max: 10, count: 0 },
                { label: '11-20mm', min: 11, max: 20, count: 0 },
                { label: '21-30mm', min: 21, max: 30, count: 0 },
                { label: '31-50mm', min: 31, max: 50, count: 0 },
                { label: '51-100mm', min: 51, max: 100, count: 0 },
                { label: '>100mm', min: 101, max: Infinity, count: 0 }
            ];
            
            dadosChuva.forEach(d => {
                for (let faixa of faixas) {
                    if (d.chuva_mm >= faixa.min && d.chuva_mm <= faixa.max) {
                        faixa.count++;
                        break;
                    }
                }
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: faixas.map(f => f.label),
                    datasets: [{
                        label: 'Frequ√™ncia de Eventos',
                        data: faixas.map(f => f.count),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: (context) => `${context.parsed.y} evento${context.parsed.y !== 1 ? 's' : ''}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            title: {
                                display: true,
                                text: 'N√∫mero de Eventos',
                                font: { size: 12, weight: 'bold' }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Faixa de Precipita√ß√£o',
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        // ===== GR√ÅFICO DE INTERVALOS =====
        function criarGraficoIntervalos() {
            const ctx = document.getElementById('intervalsChart').getContext('2d');
            const stat = estatisticas[temporadaAtual];
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stat.intervalos.map((_, i) => `Int. ${i + 1}`),
                    datasets: [{
                        label: 'Dias entre Chuvas',
                        data: stat.intervalos,
                        backgroundColor: 'rgba(13, 110, 253, 0.7)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: { size: 13, weight: '600' }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Dias',
                                font: { size: 12, weight: 'bold' }
                            }
                        }
                    }
                }
            });
        }

        // ===== RADAR COMPARATIVO =====
        function criarRadarChart() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            const datasets = [];
            const cores = [
                { bg: 'rgba(255, 99, 132, 0.2)', border: 'rgba(255, 99, 132, 1)' },
                { bg: 'rgba(54, 162, 235, 0.2)', border: 'rgba(54, 162, 235, 1)' },
                { bg: 'rgba(75, 192, 192, 0.2)', border: 'rgba(75, 192, 192, 1)' }
            ];
            
            Object.keys(estatisticas).sort().forEach((temp, idx) => {
                const mediaPorMes = Array(12).fill(0);
                const contagemPorMes = Array(12).fill(0);
                
                dadosChuva
                    .filter(d => d.temporada === temp)
                    .forEach(item => {
                        const mes = new Date(item.data).getMonth();
                        mediaPorMes[mes] += item.chuva_mm;
                        contagemPorMes[mes]++;
                    });
                
                const medias = mediaPorMes.map((total, idx) => 
                    contagemPorMes[idx] > 0 ? total / contagemPorMes[idx] : 0
                );
                
                datasets.push({
                    label: temp,
                    data: medias,
                    backgroundColor: cores[idx % cores.length].bg,
                    borderColor: cores[idx % cores.length].border,
                    borderWidth: 2,
                    pointRadius: 4
                });
            });
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: mesesNomes,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 13, weight: '600' }
                            }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 20,
                                callback: (value) => value + 'mm'
                            }
                        }
                    }
                }
            });
        }

        // ===== MAPA DE CALOR GITHUB =====
        function criarMapaCalorGitHub() {
            const container = document.getElementById('githubHeatmap');
            
            // √öltimos 365 dias
            const hoje = new Date();
            const umAnoAtras = new Date(hoje.getTime() - (365 * 24 * 60 * 60 * 1000));
            
            // Criar objeto com todas as datas
            const dadosPorDia = {};
            let dataAtual = new Date(umAnoAtras);
            while (dataAtual <= hoje) {
                const key = dataAtual.toISOString().split('T')[0];
                dadosPorDia[key] = 0;
                dataAtual.setDate(dataAtual.getDate() + 1);
            }
            
            // Preencher com dados reais
            dadosChuva.forEach(d => {
                if (dadosPorDia[d.data] !== undefined) {
                    dadosPorDia[d.data] = d.chuva_mm;
                }
            });
            
            // Determinar n√≠veis (0-4 baseado em percentis)
            const valores = Object.values(dadosPorDia).filter(v => v > 0);
            valores.sort((a, b) => a - b);
            const p25 = valores[Math.floor(valores.length * 0.25)] || 10;
            const p50 = valores[Math.floor(valores.length * 0.50)] || 25;
            const p75 = valores[Math.floor(valores.length * 0.75)] || 50;
            
            function getNivel(valor) {
                if (valor === 0) return 0;
                if (valor < p25) return 1;
                if (valor < p50) return 2;
                if (valor < p75) return 3;
                return 4;
            }
            
            const html = `
                <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                    <span class="small text-muted">Menos</span>
                    <div class="heatmap-cell" data-level="0" style="width: 15px; height: 15px;"></div>
                    <div class="heatmap-cell" data-level="1" style="width: 15px; height: 15px;"></div>
                    <div class="heatmap-cell" data-level="2" style="width: 15px; height: 15px;"></div>
                    <div class="heatmap-cell" data-level="3" style="width: 15px; height: 15px;"></div>
                    <div class="heatmap-cell" data-level="4" style="width: 15px; height: 15px;"></div>
                    <span class="small text-muted">Mais</span>
                </div>
                <div style="overflow-x: auto;">
                    <div class="heatmap-grid">
                        ${Object.entries(dadosPorDia).map(([data, valor]) => {
                            const nivel = getNivel(valor);
                            const d = new Date(data);
                            const label = valor > 0 
                                ? `${d.toLocaleDateString('pt-BR')}: ${valor}mm`
                                : `${d.toLocaleDateString('pt-BR')}: Sem chuva`;
                            return `<div class="heatmap-cell" data-level="${nivel}" title="${label}"></div>`;
                        }).join('')}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // ===== TABELA =====
        function preencherTabela() {
            const tbody = document.getElementById('tableBody');
            document.getElementById('recordCount').textContent = dadosChuva.length;
            
            dadosChuva.forEach((item, idx) => {
                const dataFormatada = new Date(item.data).toLocaleDateString('pt-BR');
                const chuvaClass = item.chuva_mm > 50 ? 'high-rain' : '';
                
                let intensidade, badgeClass;
                if (item.chuva_mm < 10) {
                    intensidade = 'Fraca';
                    badgeClass = 'bg-secondary';
                } else if (item.chuva_mm < 30) {
                    intensidade = 'Moderada';
                    badgeClass = 'bg-info';
                } else if (item.chuva_mm < 50) {
                    intensidade = 'Forte';
                    badgeClass = 'bg-warning';
                } else {
                    intensidade = 'Muito Forte';
                    badgeClass = 'bg-danger';
                }
                
                let intervalo = '-';
                if (idx < dadosChuva.length - 1) {
                    const diff = Math.abs(new Date(dadosChuva[idx].data) - new Date(dadosChuva[idx + 1].data));
                    intervalo = `${Math.floor(diff / (1000 * 60 * 60 * 24))} dias`;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${dataFormatada}</strong></td>
                    <td class="${chuvaClass}">
                        ${item.chuva_mm.toFixed(0)} mm
                        ${item.chuva_mm > 50 ? '<i class="fas fa-exclamation-circle ms-1"></i>' : ''}
                    </td>
                    <td><span class="badge ${badgeClass}">${intensidade}</span></td>
                    <td><span class="badge bg-primary">${item.temporada}</span></td>
                    <td class="text-muted small">${intervalo}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // ===== FILTROS =====
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const filter = this.dataset.filter;
                
                if (filter === 'compare') {
                    document.getElementById('comparativoSection').style.display = 'block';
                    gerarComparativo();
                } else {
                    document.getElementById('comparativoSection').style.display = 'none';
                }
                
                // Aqui voc√™ poderia filtrar os gr√°ficos tamb√©m
            });
        });

        // ===== COMPARATIVO =====
        function gerarComparativo() {
            const container = document.getElementById('comparisonContainer');
            container.innerHTML = '';
            
            Object.keys(estatisticas).sort().forEach(temp => {
                const stat = estatisticas[temp];
                const percDoMaior = (stat.total / Math.max(...Object.values(estatisticas).map(s => s.total))) * 100;
                
                container.innerHTML += `
                    <div class="comparison-card">
                        <h5 class="mb-3">${temp}</h5>
                        <div class="text-center">
                            <div style="width: 100px; height: 100px; margin: 0 auto; background: conic-gradient(var(--primary-blue) ${percDoMaior * 3.6}deg, #e0e0e0 0deg); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <div style="width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                    <strong style="font-size: 1.5rem; color: var(--primary-blue);">${stat.total.toFixed(0)}</strong>
                                    <small style="font-size: 0.7rem;">mm</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 small text-muted">
                            <div>üìä ${stat.count} eventos</div>
                            <div>üìà M√©dia: ${stat.media.toFixed(1)}mm</div>
                            <div>üéØ ${percDoMaior.toFixed(0)}% do maior</div>
                        </div>
                    </div>
                `;
            });
        }

        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                gerarDashboardExecutivo();
                gerarKPIs();
                gerarEstatisticas();
                criarGraficoMultiSafra();
                criarGraficoDistribuicao();
                criarGraficoIntervalos();
                criarRadarChart();
                criarMapaCalorGitHub();
                preencherTabela();
            }, 100);
        });
    </script>
</body>
</html>