<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fazenda Cacimbas - Dashboard de Chuvas</title>
  <meta name="description" content="Dashboard de monitoramento de chuvas e gest√£o h√≠drica para a Fazenda Cacimbas">
  <meta name="theme-color" content="#2563eb">

  <!-- Tailwind CSS (production build) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            rain: { light: '#dbeafe', base: '#2563eb', dark: '#1e40af' },
            drought: { light: '#fed7aa', base: '#f97316', dark: '#c2410c' },
            good: { light: '#dcfce7', base: '#10b981', dark: '#047857' },
            bad: { light: '#fee2e2', base: '#dc2626', dark: '#991b1b' }
          },
          animation: { 'fadeIn': 'fadeIn 0.3s ease-in-out' },
          keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Inter:wght@400;500;600&display=swap');
    
    * { font-family: 'Inter', -apple-system, sans-serif; }
    h1, h2, h3, .fw-bold { font-family: 'Poppins', sans-serif; }
    
    body { @apply bg-slate-50 text-slate-900; }
    
    .glass-card { 
      @apply bg-white rounded-2xl p-5 shadow-sm border border-slate-100;
      backdrop-filter: blur(10px);
    }
    
    .glass-card:hover { @apply shadow-md transition-shadow duration-200; }
    
    .badge-weather { 
      @apply inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-semibold;
    }
    
    .chip-season {
      @apply inline-flex items-center gap-2 px-4 py-2 rounded-full border-2 border-slate-200 text-sm font-bold;
      @apply cursor-pointer transition-all duration-150 hover:border-blue-300;
    }
    
    .chip-season.active {
      @apply bg-rain-base text-white border-rain-base;
    }
    
    .heatmap-cell {
      @apply w-10 h-10 rounded-lg flex items-center justify-center text-xs font-bold;
      @apply cursor-help transition-transform duration-150 hover:scale-110;
    }
    
    .heatmap-cell:hover { @apply shadow-lg; }
    
    .alert-banner {
      @apply p-4 rounded-xl border-l-4 flex items-start gap-3;
      @apply animate-fadeIn;
    }
    
    .alert-banner.critical { @apply bg-bad-light border-bad-base text-bad-dark; }
    .alert-banner.warning { @apply bg-drought-light border-drought-base text-drought-dark; }
    .alert-banner.success { @apply bg-good-light border-good-base text-good-dark; }
    
    .loading { @apply animate-pulse; }
    
    .chart-container {
      @apply relative w-full h-96 sm:h-80 md:h-96 lg:h-full;
    }
    
    @media (max-width: 768px) {
      .chip-season { @apply px-3 py-1.5 text-xs; }
      .heatmap-cell { @apply w-8 h-8 text-xs; }
      .glass-card { @apply p-4; }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen flex flex-col">
  
  <!-- Header -->
  <header class="bg-gradient-to-r from-rain-dark to-rain-base text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center shadow-md">
            <svg class="w-8 h-8 text-rain-base" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8zm0 18c-3.35 0-6-2.57-6-6.2 0-2.34 1.95-5.44 6-9.14 4.05 3.7 6 6.79 6 9.14 0 3.63-2.65 6.2-6 6.2z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-3xl font-bold">Fazenda Cacimbas</h1>
            <p class="text-blue-100 text-sm">Dashboard de Monitoramento H√≠drico</p>
          </div>
        </div>
        <div class="text-right hidden sm:block">
          <p class="font-semibold" id="currentDate"></p>
          <p class="text-blue-100 text-sm">Ciclo agr√≠cola e hist√≥rico</p>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-1 max-w-7xl mx-auto w-full px-4 py-6 sm:px-6 lg:px-8 space-y-6">
    
    <!-- Alertas de Status -->
    <div id="alertContainer" class="space-y-3"></div>

    <!-- Controles Principais -->
    <div class="glass-card">
      <div class="flex flex-col lg:flex-row gap-6 justify-between">
        <div class="flex-1">
          <h2 class="text-lg font-bold mb-2">üéØ Sele√ß√£o de Safras</h2>
          <p class="text-sm text-slate-600 mb-4">Escolha 1 safra para an√°lise di√°ria ou at√© 4 para compara√ß√£o mensal/anual</p>
          <div class="flex gap-2 flex-wrap">
            <button class="px-4 py-2 bg-rain-base text-white rounded-lg hover:bg-rain-dark transition" onclick="openAddModal()" aria-label="Adicionar novo registro de chuva">
              <span>‚ûï Novo Registro</span>
            </button>
            <button class="px-4 py-2 border-2 border-slate-300 rounded-lg hover:bg-slate-50 transition" onclick="toggleRadar()" aria-label="Alternar radar FUNCEME">
              <span>üõ∞Ô∏è Radar FUNCEME</span>
            </button>
            <button class="px-4 py-2 border-2 border-slate-300 rounded-lg hover:bg-slate-50 transition" onclick="exportCSV()" aria-label="Exportar dados em CSV">
              <span>üì• Exportar CSV</span>
            </button>
            <label class="px-4 py-2 border-2 border-slate-300 rounded-lg hover:bg-slate-50 transition cursor-pointer" aria-label="Importar arquivo CSV">
              <span>üì§ Importar CSV</span>
              <input type="file" accept=".csv" hidden onchange="importCSV(event)">
            </label>
          </div>
        </div>
        <div class="lg:w-40">
          <h3 class="text-sm font-bold text-slate-600 mb-2">A√ß√µes R√°pidas:</h3>
          <div class="flex flex-wrap gap-2">
            <button class="px-3 py-1 text-xs bg-slate-100 rounded-lg hover:bg-slate-200 transition" onclick="selectPreset('last')">√öltima</button>
            <button class="px-3 py-1 text-xs bg-good-light text-good-dark rounded-lg hover:bg-good-base hover:text-white transition" onclick="selectPreset('best')">Melhor</button>
            <button class="px-3 py-1 text-xs bg-bad-light text-bad-dark rounded-lg hover:bg-bad-base hover:text-white transition" onclick="selectPreset('worst')">Pior</button>
            <button class="px-3 py-1 text-xs bg-slate-100 rounded-lg hover:bg-slate-200 transition" onclick="selectPreset('clear')">Limpar</button>
          </div>
        </div>
      </div>

      <div id="radarBox" class="hidden mt-4 w-full h-96 rounded-xl overflow-hidden border border-slate-200">
        <iframe src="https://radar.funceme.br/radar-mini" width="100%" height="100%" style="border:0;"></iframe>
      </div>

      <hr class="my-4 border-slate-200">

      <!-- Chips de Safras -->
      <div class="mb-4">
        <p class="text-xs font-bold text-slate-600 mb-2 uppercase">Safras dispon√≠veis:</p>
        <div id="seasonChips" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Modo de Visualiza√ß√£o -->
      <div class="flex flex-col sm:flex-row items-center gap-4">
        <p class="text-xs font-bold text-slate-600 uppercase">Modo:</p>
        <div class="flex gap-2 flex-wrap" role="group" aria-label="Sele√ß√£o de modo de visualiza√ß√£o">
          <input type="radio" id="modeAnnual" name="viewMode" class="hidden peer" checked>
          <label for="modeAnnual" class="px-4 py-2 border-2 border-slate-300 rounded-lg cursor-pointer transition peer-checked:bg-rain-base peer-checked:text-white peer-checked:border-rain-base hover:border-rain-base">Anual</label>

          <input type="radio" id="modeMonthly" name="viewMode" class="hidden peer">
          <label for="modeMonthly" class="px-4 py-2 border-2 border-slate-300 rounded-lg cursor-pointer transition peer-checked:bg-rain-base peer-checked:text-white peer-checked:border-rain-base hover:border-rain-base">Mensal</label>

          <input type="radio" id="modeDaily" name="viewMode" class="hidden peer">
          <label for="modeDaily" class="px-4 py-2 border-2 border-slate-300 rounded-lg cursor-pointer transition peer-checked:bg-rain-base peer-checked:text-white peer-checked:border-rain-base hover:border-rain-base">Di√°rio</label>

          <input type="radio" id="modeCalendar" name="viewMode" class="hidden peer">
          <label for="modeCalendar" class="px-4 py-2 border-2 border-slate-300 rounded-lg cursor-pointer transition peer-checked:bg-rain-base peer-checked:text-white peer-checked:border-rain-base hover:border-rain-base">Calend√°rio</label>
        </div>
        <span class="text-xs text-slate-500 ml-auto" id="modeHint"></span>
      </div>
    </div>

    <!-- Grid Principal (KPI + Gr√°fico + Tabela) -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- KPI + Classifica√ß√£o -->
      <div class="glass-card lg:col-span-1">
        <h2 class="text-lg font-bold mb-4">üìä Indicadores</h2>
        <div id="kpiContainer" class="space-y-3 mb-4"></div>
        
        <hr class="my-4 border-slate-200">
        
        <h3 class="text-sm font-bold mb-2">‚≠ê Classifica√ß√£o (Quartis)</h3>
        <p class="text-xs text-slate-600 mb-3">Baseada no hist√≥rico de chuvas anuais</p>
        <div id="rankingBox" class="space-y-2 max-h-96 overflow-y-auto"></div>
      </div>

      <!-- Gr√°fico Principal -->
      <div class="glass-card lg:col-span-2">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h2 class="text-lg font-bold" id="chartTitle">Anual (Totais)</h2>
            <span class="text-xs text-slate-500" id="modeHint2"></span>
          </div>
          <span class="text-xs px-3 py-1 bg-blue-100 text-blue-900 rounded-full font-semibold" id="chartLabel">Hist√≥rico</span>
        </div>
        <div class="chart-container">
          <canvas id="mainChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Heatmap (Calend√°rio) -->
    <div class="glass-card hidden" id="cardHeatmap">
      <h2 class="text-lg font-bold mb-4">üìÖ Calend√°rio de Chuvas</h2>
      <p class="text-sm text-slate-600 mb-4">Cada c√©lula representa um dia. N√∫mero = dia do m√™s. Cor = intensidade da chuva.</p>
      <div id="heatmapContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto"></div>
      <div class="mt-4 flex gap-6 text-xs">
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded bg-slate-300"></div><span>Sem chuva</span></div>
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded bg-blue-300"></div><span>Leve (&lt;20mm)</span></div>
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded bg-rain-base"></div><span>Moderada (20-50mm)</span></div>
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded bg-rain-dark"></div><span>Forte (50-90mm)</span></div>
        <div class="flex items-center gap-2"><div class="w-6 h-6 rounded bg-good-base border-2 border-yellow-400"></div><span>Abundante (&gt;90mm)</span></div>
      </div>
    </div>

    <!-- Tabela de Registros -->
    <div class="glass-card">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">üìã Registros Recentes</h2>
        <span class="text-xs text-slate-600" id="tableHint"></span>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" role="table" aria-label="Tabela de registros de chuva">
          <thead class="bg-slate-100 border-b-2 border-slate-300">
            <tr>
              <th class="text-left px-4 py-3 font-bold">Data</th>
              <th class="text-center px-4 py-3 font-bold">Volume (mm)</th>
              <th class="text-center px-4 py-3 font-bold">Safra</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
        <p class="text-xs text-slate-500 mt-3 px-4">üí° Dica: Registre sempre em mm e use o ano como refer√™ncia de safra para manter consist√™ncia.</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t border-slate-200 text-center py-6 text-sm text-slate-600 mt-auto">
    <p class="font-semibold">Desenvolvido por <strong>Murilo Feitosa</strong></p>
    <p>Fazenda Cacimbas ¬© 2026 | <a href="#" class="text-rain-base hover:underline">Suporte</a> ‚Ä¢ <a href="#" class="text-rain-base hover:underline">Documenta√ß√£o</a></p>
  </footer>

  <!-- Modal: Adicionar Registro -->
  <div id="modalAdd" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="if(event.target.id==='modalAdd') closeAddModal()">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 animate-fadeIn">
      <h2 class="text-2xl font-bold mb-4">‚ûï Novo Registro de Chuva</h2>
      
      <div class="space-y-4 mb-6">
        <div>
          <label class="block text-sm font-bold mb-1">Data *</label>
          <input type="date" id="addDate" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-rain-base focus:outline-none transition" aria-label="Data da chuva">
        </div>
        
        <div>
          <label class="block text-sm font-bold mb-1">Volume (mm) *</label>
          <input type="number" id="addValue" min="0" step="0.1" placeholder="Ex.: 12.5" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-rain-base focus:outline-none transition" aria-label="Volume de chuva em mil√≠metros">
        </div>
        
        <div>
          <label class="block text-sm font-bold mb-1">Safra (Ano) *</label>
          <input type="text" id="addSeason" placeholder="Ex.: 2026" inputmode="numeric" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg focus:border-rain-base focus:outline-none transition" aria-label="Ano da safra">
          <p class="text-xs text-slate-600 mt-1">Use o ano de refer√™ncia. Ex: chuvas de fev/2026 ‚Üí safra 2026</p>
        </div>
      </div>

      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded mb-6">
        <p class="text-xs text-yellow-900">‚ö†Ô∏è Os dados s√£o salvos localmente no seu navegador (localStorage). Para backup e migra√ß√£o, use Exportar CSV.</p>
      </div>

      <div class="flex gap-3">
        <button class="flex-1 px-4 py-2 border-2 border-slate-300 rounded-lg hover:bg-slate-50 transition font-bold" onclick="closeAddModal()">Cancelar</button>
        <button class="flex-1 px-4 py-2 bg-rain-base text-white rounded-lg hover:bg-rain-dark transition font-bold" onclick="addRecord()">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Toast de Notifica√ß√£o -->
  <div id="toast" class="fixed bottom-4 right-4 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-lg hidden z-50 max-w-xs" role="status" aria-live="polite"></div>

  <script>
    // ============================================================
    // 1) DADOS E ESTADO
    // ============================================================
    const rawDataBase = [
      { date: '2013-01-01', value: 312, season: '2013' },
      { date: '2014-01-01', value: 499, season: '2014' },
      { date: '2015-01-01', value: 478, season: '2015' },
      { date: '2016-01-01', value: 605, season: '2016' },
      { date: '2017-01-01', value: 352, season: '2017' },
      { date: '2018-01-01', value: 430, season: '2018' },
      { date: '2019-01-01', value: 712, season: '2019' },
      { date: '2020-01-01', value: 898, season: '2020' },
      { date: '2021-01-01', value: 609, season: '2021' },
      { date: '2022-01-01', value: 595, season: '2022' },
      { date: '2023-11-06', value: 6, season: '2024' },
      { date: '2023-11-28', value: 8, season: '2024' },
      { date: '2023-12-18', value: 9, season: '2024' },
      { date: '2023-12-20', value: 48, season: '2024' },
      { date: '2023-12-21', value: 10, season: '2024' },
      { date: '2024-01-12', value: 20, season: '2024' },
      { date: '2024-02-09', value: 9, season: '2024' },
      { date: '2024-02-11', value: 20, season: '2024' },
      { date: '2024-02-13', value: 11, season: '2024' },
      { date: '2024-02-18', value: 39, season: '2024' },
      { date: '2024-02-21', value: 59, season: '2024' },
      { date: '2024-02-27', value: 28, season: '2024' },
      { date: '2024-02-28', value: 30, season: '2024' },
      { date: '2024-03-01', value: 8, season: '2024' },
      { date: '2024-03-04', value: 8, season: '2024' },
      { date: '2024-03-05', value: 16, season: '2024' },
      { date: '2024-03-13', value: 19, season: '2024' },
      { date: '2024-03-27', value: 19, season: '2024' },
      { date: '2024-03-30', value: 21, season: '2024' },
      { date: '2024-03-31', value: 110, season: '2024' },
      { date: '2024-04-02', value: 11, season: '2024' },
      { date: '2024-04-03', value: 5, season: '2024' },
      { date: '2024-04-10', value: 32, season: '2024' },
      { date: '2024-04-11', value: 2, season: '2024' },
      { date: '2024-04-12', value: 14, season: '2024' },
      { date: '2024-04-14', value: 3, season: '2024' },
      { date: '2024-04-15', value: 11, season: '2024' },
      { date: '2024-04-16', value: 6, season: '2024' },
      { date: '2024-04-20', value: 5, season: '2024' },
      { date: '2024-04-21', value: 23, season: '2024' },
      { date: '2024-04-22', value: 11, season: '2024' },
      { date: '2024-12-03', value: 40, season: '2025' },
      { date: '2025-01-13', value: 14, season: '2025' },
      { date: '2025-01-14', value: 105, season: '2025' },
      { date: '2025-01-15', value: 34, season: '2025' },
      { date: '2025-01-20', value: 95, season: '2025' },
      { date: '2025-01-23', value: 10, season: '2025' },
      { date: '2025-02-17', value: 11, season: '2025' },
      { date: '2025-02-19', value: 22, season: '2025' },
      { date: '2025-02-24', value: 34, season: '2025' },
      { date: '2025-02-28', value: 50, season: '2025' },
      { date: '2025-03-01', value: 56, season: '2025' },
      { date: '2025-03-03', value: 10, season: '2025' },
      { date: '2025-03-04', value: 30, season: '2025' },
      { date: '2025-03-06', value: 6, season: '2025' },
      { date: '2025-03-07', value: 100, season: '2025' },
      { date: '2025-03-08', value: 24, season: '2025' },
      { date: '2025-03-11', value: 5, season: '2025' },
      { date: '2025-03-17', value: 9, season: '2025' },
      { date: '2025-03-18', value: 77, season: '2025' },
      { date: '2025-03-22', value: 9, season: '2025' },
      { date: '2025-03-28', value: 40, season: '2025' },
      { date: '2025-04-02', value: 10, season: '2025' },
      { date: '2025-04-22', value: 19, season: '2025' },
      { date: '2025-05-05', value: 11, season: '2025' },
      { date: '2025-05-10', value: 10, season: '2025' },
      { date: '2025-05-21', value: 9, season: '2025' },
      { date: '2025-10-21', value: 20, season: '2026' },
      { date: '2025-12-22', value: 55, season: '2026' },
      { date: '2025-12-23', value: 18, season: '2026' },
      { date: '2026-01-21', value: 7, season: '2026' },
      { date: '2026-01-27', value: 59, season: '2026' },
      { date: '2026-01-29', value: 40, season: '2026' },
      { date: '2026-02-05', value: 20, season: '2026' },
      { date: '2026-02-07', value: 8, season: '2026' },
      { date: '2026-02-08', value: 10, season: '2026' },
      { date: '2026-02-11', value: 5, season: '2026' },
      { date: '2026-02-12', value: 20, season: '2026' },
      { date: '2026-02-15', value: 4, season: '2026' },
      { date: '2026-02-16', value: 38, season: '2026' },
      { date: '2026-02-18', value: 15, season: '2026' },
      { date: '2026-02-27', value: 24, season: '2026' }
    ];

    const monthNames = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
    const LS_KEY = "cacimbas_rain_v3";

    const state = {
      viewMode: "annual",
      selectedSeasons: [],
      data: [],
      cachedTotals: null,
      cachedClassification: null
    };

    let chartMain = null;

    // ============================================================
    // 2) UTILIDADES E STORAGE
    // ============================================================
    function getStorage(){
      try {
        if(localStorage) return localStorage;
      } catch(e) {}
      showToast("‚ö†Ô∏è Armazenamento local desabilitado. Dados n√£o ser√£o salvos entre sess√µes.", 5000);
      return { getItem: () => null, setItem: () => {}, removeItem: () => {} };
    }

    function showToast(msg, duration = 2500){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.remove("hidden");
      setTimeout(() => el.classList.add("hidden"), duration);
    }

    function formatDate(dateStr){
      const d = new Date(dateStr + "T00:00:00");
      return d.toLocaleDateString("pt-BR");
    }

    function formatNumber(n){
      return Math.round(n).toLocaleString("pt-BR");
    }

    function isValidISODate(dateStr){
      return /^\d{4}-\d{2}-\d{2}$/.test(dateStr) && !isNaN(new Date(dateStr + "T00:00:00"));
    }

    function toggleRadar(){
      const box = document.getElementById("radarBox");
      box.classList.toggle("hidden");
    }

    function openAddModal(){
      const modal = document.getElementById("modalAdd");
      modal.classList.remove("hidden");
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("addDate").value = today;
      document.getElementById("addSeason").value = new Date().getFullYear();
      document.getElementById("addDate").focus();
    }

    function closeAddModal(){
      document.getElementById("modalAdd").classList.add("hidden");
    }

    // ============================================================
    // 3) CARREGAMENTO E CONSOLIDA√á√ÉO DE DADOS
    // ============================================================
    function normalizeBaseData(list){
      return list.map(d => {
        const year = Number(d.season);
        const kind = (year <= 2022 && String(d.date).endsWith("-01-01")) ? "annual_total" : "daily";
        return {
          date: String(d.date),
          value: Math.max(0, Number(d.value) || 0),
          season: String(d.season),
          kind
        };
      });
    }

    function loadExtra(){
      const saved = getStorage().getItem(LS_KEY);
      if(!saved) return [];
      try {
        const extra = JSON.parse(saved);
        return Array.isArray(extra) ? extra
          .map(r => ({
            date: String(r.date),
            value: Math.max(0, Number(r.value) || 0),
            season: String(r.season),
            kind: "daily"
          }))
          .filter(r => isValidISODate(r.date) && /^\d{4}$/.test(r.season))
          : [];
      } catch {
        return [];
      }
    }

    function saveExtra(list){
      getStorage().setItem(LS_KEY, JSON.stringify(list.slice(0, 5000))); // limita 5k
    }

    function loadData(){
      const base = normalizeBaseData(rawDataBase);
      const extra = loadExtra();
      const merged = [...base, ...extra];

      const map = new Map();
      merged.forEach(r => {
        const k = `${r.season}__${r.date}__${r.kind}`;
        if(!map.has(k)){
          map.set(k, {...r});
        } else {
          const ex = map.get(k);
          if(r.kind === "daily"){
            ex.value += r.value;
          } else {
            ex.value = Math.max(ex.value, r.value);
          }
          map.set(k, ex);
        }
      });

      return Array.from(map.values());
    }

    // ============================================================
    // 4) M√âTRICA AGREGA√á√ÉO (COM CACHE)
    // ============================================================
    function annualTotals(){
      if(state.cachedTotals) return state.cachedTotals;

      const bySeason = {};
      const hasAnnual = new Set();

      state.data.forEach(r => {
        if(!bySeason[r.season]) bySeason[r.season] = { annual: 0, dailySum: 0 };
        if(r.kind === "annual_total"){
          bySeason[r.season].annual += r.value;
          hasAnnual.add(r.season);
        } else {
          bySeason[r.season].dailySum += r.value;
        }
      });

      const result = Object.keys(bySeason)
        .map(season => ({
          season,
          total: Math.round(hasAnnual.has(season) ? bySeason[season].annual : bySeason[season].dailySum)
        }))
        .sort((a,b) => Number(a.season) - Number(b.season));

      state.cachedTotals = result;
      return result;
    }

    function quartiles(nums){
      if(nums.length === 0) return { q1: 0, q3: 0 };
      const a = [...nums].sort((x,y) => x-y);
      const q = (p) => {
        const pos = (a.length - 1) * p;
        const base = Math.floor(pos);
        const rest = pos - base;
        return a[base+1] ? a[base] + rest * (a[base+1] - a[base]) : a[base];
      };
      return { q1: q(0.25), q3: q(0.75) };
    }

    function classifySeasons(){
      if(state.cachedClassification) return state.cachedClassification;

      const totals = annualTotals();
      const values = totals.map(t => t.total);

      let map = new Map();
      if(values.length < 4){
        const sorted = [...values].sort((a,b) => a-b);
        const median = sorted[Math.floor(sorted.length/2)] || 0;
        totals.forEach(t => map.set(t.season, t.total >= median ? "good" : "bad"));
        state.cachedClassification = { map, q1: null, q3: null };
        return state.cachedClassification;
      }

      const { q1, q3 } = quartiles(values);
      totals.forEach(t => {
        let cls = "mid";
        if(t.total <= q1) cls = "bad";
        if(t.total >= q3) cls = "good";
        map.set(t.season, cls);
      });

      state.cachedClassification = { map, q1, q3 };
      return state.cachedClassification;
    }

    function dailyBySeason(season){
      return state.data
        .filter(r => r.kind === "daily" && r.season === season)
        .map(r => ({ ...r, dt: new Date(r.date + "T00:00:00") }))
        .sort((a,b) => a.dt - b.dt);
    }

    function monthlyTotalsForSeason(season){
      const arr = dailyBySeason(season);
      const months = Array(12).fill(0);
      arr.forEach(r => {
        months[r.dt.getMonth()] += r.value;
      });
      return months.map(v => Math.round(v));
    }

    function checkAlerts(){
      const now = new Date();
      const alerts = [];

      state.selectedSeasons.forEach(season => {
        const arr = dailyBySeason(season);
        if(arr.length === 0) return;

        const lastRain = arr[arr.length - 1];
        const daysSinceRain = Math.floor((now - lastRain.dt) / (1000*60*60*24));

        if(daysSinceRain > 30){
          alerts.push({
            type: "critical",
            title: "‚ö†Ô∏è Seca Prolongada",
            msg: `Safra ${season}: ${daysSinceRain} dias sem chuva`
          });
        }

        const totalThisMonth = arr
          .filter(r => r.dt.getMonth() === now.getMonth())
          .reduce((sum, r) => sum + r.value, 0);
        
        if(totalThisMonth < 10){
          alerts.push({
            type: "warning",
            title: "üíß Volume Cr√≠tico",
            msg: `Este m√™s em ${season}: apenas ${Math.round(totalThisMonth)}mm`
          });
        }
      });

      return alerts;
    }

    function renderAlerts(){
      const container = document.getElementById("alertContainer");
      container.innerHTML = "";

      const alerts = checkAlerts();
      if(alerts.length === 0) return;

      alerts.forEach(a => {
        const el = document.createElement("div");
        el.className = `alert-banner ${a.type}`;
        el.innerHTML = `<div class="flex-1"><strong>${a.title}</strong><p class="text-sm mt-1">${a.msg}</p></div>`;
        container.appendChild(el);
      });
    }

    // ============================================================
    // 5) UI: CHIPS, KPI, RANKING
    // ============================================================
    function getSeasons(){
      return [...new Set(state.data.map(d => d.season))].sort((a,b) => Number(b)-Number(a));
    }

    function renderSeasonChips(){
      const seasons = getSeasons();
      const box = document.getElementById("seasonChips");
      box.innerHTML = "";

      seasons.forEach(season => {
        const active = state.selectedSeasons.includes(season);
        const btn = document.createElement("button");
        btn.className = `chip-season ${active ? "active" : ""}`;
        btn.textContent = season;
        btn.type = "button";
        btn.onclick = () => toggleSeason(season);
        btn.setAttribute("aria-pressed", active);
        box.appendChild(btn);
      });
    }

    function toggleSeason(season){
      const idx = state.selectedSeasons.indexOf(season);
      if(idx >= 0){
        state.selectedSeasons.splice(idx, 1);
      } else {
        if(state.selectedSeasons.length >= 4){
          showToast("‚ö†Ô∏è M√°ximo 4 safras para compara√ß√£o");
          return;
        }
        state.selectedSeasons.push(season);
      }
      invalidateCache();
      rebuild();
    }

    function selectPreset(type){
      const totals = annualTotals();
      if(totals.length === 0) return;

      if(type === "clear") state.selectedSeasons = [];
      else if(type === "last") state.selectedSeasons = [totals[totals.length-1].season];
      else if(type === "best") state.selectedSeasons = [totals.sort((a,b) => b.total - a.total)[0].season];
      else if(type === "worst") state.selectedSeasons = [totals.sort((a,b) => a.total - b.total)[0].season];

      invalidateCache();
      rebuild();
    }

    function invalidateCache(){
      state.cachedTotals = null;
      state.cachedClassification = null;
    }

    function renderKPIs(){
      const totals = annualTotals();
      const { map } = classifySeasons();

      const best = totals.length ? totals.sort((a,b) => b.total - a.total)[0] : null;
      const worst = totals.length ? totals.sort((a,b) => a.total - b.total)[0] : null;

      let selTotal = 0, selDays = 0;
      state.selectedSeasons.forEach(s => {
        const t = totals.find(x => x.season === s);
        if(t) selTotal += t.total;
        selDays += dailyBySeason(s).length;
      });

      const html = `
        <div class="p-3 border-2 border-good-light rounded-lg bg-good-light">
          <p class="text-xs font-bold text-slate-600 uppercase mb-1">Melhor Safra</p>
          <p class="text-2xl font-bold text-good-dark">${best ? best.total : 0}<span class="text-sm text-slate-600">mm</span></p>
          <p class="text-xs text-slate-600">${best ? "Safra " + best.season : "-"}</p>
        </div>
        <div class="p-3 border-2 border-bad-light rounded-lg bg-bad-light">
          <p class="text-xs font-bold text-slate-600 uppercase mb-1">Pior Safra</p>
          <p class="text-2xl font-bold text-bad-dark">${worst ? worst.total : 0}<span class="text-sm text-slate-600">mm</span></p>
          <p class="text-xs text-slate-600">${worst ? "Safra " + worst.season : "-"}</p>
        </div>
        <div class="p-3 border-2 border-slate-300 rounded-lg bg-white col-span-full">
          <p class="text-xs font-bold text-slate-600 uppercase mb-2">Sele√ß√£o Atual</p>
          <p class="text-sm font-bold mb-1">${state.selectedSeasons.length ? state.selectedSeasons.join(", ") : "Nenhuma"}</p>
          <p class="text-xs text-slate-600">Total: <strong>${formatNumber(selTotal)}</strong>mm | Dias: <strong>${selDays}</strong></p>
        </div>
      `;

      document.getElementById("kpiContainer").innerHTML = `<div class="grid grid-cols-2 gap-3">${html}</div>`;

      // Ranking
      const rankBox = document.getElementById("rankingBox");
      const sorted = [...totals].sort((a,b) => b.total - a.total);
      const top = sorted.slice(0,5), bot = sorted.reverse().slice(0,5);

      const badgeClass = (season) => {
        const cls = map.get(season) || "mid";
        if(cls === "good") return "bg-good-light text-good-dark";
        if(cls === "bad") return "bg-bad-light text-bad-dark";
        return "bg-slate-100 text-slate-700";
      };

      const rankHtml = `
        <div class="font-bold text-sm mb-2">Top 5</div>
        ${top.length ? top.map((x,i) => `
          <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg mb-1">
            <span class="text-sm font-bold">${i+1}. Safra ${x.season}</span>
            <div class="flex gap-2 items-center">
              <span class="text-xs px-2 py-1 rounded-full ${badgeClass(x.season)}">${map.get(x.season) === "good" ? "Bom" : (map.get(x.season) === "bad" ? "Ruim" : "Regular")}</span>
              <span class="font-bold">${x.total}mm</span>
            </div>
          </div>
        `).join("") : `<p class="text-xs text-slate-500">Sem dados</p>`}
        
        <div class="font-bold text-sm mt-3 mb-2">Bottom 5</div>
        ${bot.length ? bot.map((x,i) => `
          <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg mb-1">
            <span class="text-sm font-bold">${i+1}. Safra ${x.season}</span>
            <div class="flex gap-2 items-center">
              <span class="text-xs px-2 py-1 rounded-full ${badgeClass(x.season)}">${map.get(x.season) === "good" ? "Bom" : (map.get(x.season) === "bad" ? "Ruim" : "Regular")}</span>
              <span class="font-bold">${x.total}mm</span>
            </div>
          </div>
        `).join("") : `<p class="text-xs text-slate-500">Sem dados</p>`}
      `;

      rankBox.innerHTML = rankHtml;
    }

    // ============================================================
    // 6) GR√ÅFICOS (Chart.js)
    // ============================================================
    function destroyChart(){
      if(chartMain){
        chartMain.destroy();
        chartMain = null;
      }
    }

    function renderAnnualChart(){
      const totals = annualTotals();
      const { map, q1, q3 } = classifySeasons();

      document.getElementById("chartTitle").textContent = "üìà Anual (Totais)";
      document.getElementById("chartLabel").textContent = "Compara√ß√£o por safra";
      document.getElementById("modeHint").textContent = "Selecione safras para destac√°-las";
      document.getElementById("modeHint2").textContent = totals.length ? `${totals.length} safras no hist√≥rico` : "Sem dados";

      destroyChart();

      const labels = totals.map(t => t.season);
      const values = totals.map(t => t.total);
      const selected = new Set(state.selectedSeasons);

      const colors = labels.map(season => {
        const cls = map.get(season) || "mid";
        return cls === "good" ? "#10b981" : (cls === "bad" ? "#dc2626" : "#2563eb");
      });

      chartMain = new Chart(document.getElementById("mainChart"), {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Total Anual (mm)",
            data: values,
            backgroundColor: colors,
            borderColor: labels.map(s => selected.has(s) ? "#0f172a" : "#e2e8f0"),
            borderWidth: labels.map(s => selected.has(s) ? 3 : 1),
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: "mm" } }
          }
        }
      });
    }

    function renderMonthlyChart(){
      const seasons = state.selectedSeasons.length ? state.selectedSeasons : [];

      document.getElementById("chartTitle").textContent = "üìÖ Mensal (Comparativo)";
      document.getElementById("chartLabel").textContent = seasons.length ? ("Safras: " + seasons.join(", ")) : "Selecione at√© 4";
      document.getElementById("modeHint").textContent = "";

      destroyChart();

      if(seasons.length === 0){
        chartMain = new Chart(document.getElementById("mainChart"), {
          type: "bar",
          data: {
            labels: monthNames,
            datasets: [{ label: "Selecione safras", data: Array(12).fill(0), backgroundColor: "#e2e8f0" }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
        return;
      }

      const palette = ["#2563eb", "#10b981", "#f97316", "#dc2626"];
      const datasets = seasons.map((s, idx) => ({
        label: "Safra " + s,
        data: monthlyTotalsForSeason(s),
        backgroundColor: palette[idx % palette.length],
        borderRadius: 4
      }));

      chartMain = new Chart(document.getElementById("mainChart"), {
        type: "bar",
        data: { labels: monthNames, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: "bottom" } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function renderDailyChart(){
      const season = state.selectedSeasons[0];

      document.getElementById("chartTitle").textContent = "üìä Di√°rio + Acumulado";
      document.getElementById("modeHint").textContent = "";

      destroyChart();

      if(!season){
        document.getElementById("chartLabel").textContent = "Selecione 1 safra";
        chartMain = new Chart(document.getElementById("mainChart"), {
          type: "bar",
          data: {
            labels: ["-"],
            datasets: [{ label: "Selecione 1 safra", data: [0], backgroundColor: "#e2e8f0" }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
        return;
      }

      const arr = dailyBySeason(season);
      document.getElementById("chartLabel").textContent = "Safra " + season;

      if(arr.length === 0){
        chartMain = new Chart(document.getElementById("mainChart"), {
          type: "bar",
          data: {
            labels: ["Sem registros"],
            datasets: [{ label: "Chuva (mm)", data: [0], backgroundColor: "#e2e8f0" }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
        return;
      }

      const labels = arr.map(r => {
        const d = r.dt;
        return String(d.getDate()).padStart(2,"0") + "/" + String(d.getMonth()+1).padStart(2,"0");
      });

      const values = arr.map(r => Math.round(r.value));
      let acc = 0;
      const acum = values.map(v => (acc += v));

      chartMain = new Chart(document.getElementById("mainChart"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Chuva (mm)", data: values, backgroundColor: "#2563eb", borderRadius: 4, yAxisID: "y" },
            { type: "line", label: "Acumulado", data: acum, borderColor: "#10b981", borderWidth: 2, pointRadius: 0, yAxisID: "y1" }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: "bottom" } },
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 12 } },
            y: { beginAtZero: true, position: "left" },
            y1: { beginAtZero: true, position: "right", grid: { drawOnChartArea: false } }
          }
        }
      });
    }

    // ============================================================
    // 7) HEATMAP
    // ============================================================
    function renderHeatmap(){
      const season = state.selectedSeasons[0];
      const card = document.getElementById("cardHeatmap");
      const container = document.getElementById("heatmapContainer");
      container.innerHTML = "";

      if(!season){
        container.innerHTML = `<p class="text-slate-600 text-sm col-span-full">Selecione 1 safra para visualizar o calend√°rio.</p>`;
        return;
      }

      const dados = dailyBySeason(season);
      if(dados.length === 0){
        container.innerHTML = `<p class="text-slate-600 text-sm col-span-full">Sem registros para a safra ${season}.</p>`;
        return;
      }

      const grouped = {};
      dados.forEach(d => {
        const key = `${d.dt.getFullYear()}-${d.dt.getMonth()}`;
        if(!grouped[key]){
          grouped[key] = { year: d.dt.getFullYear(), month: d.dt.getMonth(), days: [] };
        }
        grouped[key].days.push(d);
      });

      const blocks = Object.values(grouped).sort((a,b) =>
        a.year !== b.year ? a.year - b.year : a.month - b.month
      );

      blocks.forEach(b => {
        b.days.sort((x,y) => x.dt - y.dt);

        const daysHtml = b.days.map(day => {
          const v = Number(day.value) || 0;
          let lvl = "bg-slate-300";
          if(v > 0 && v <= 20) lvl = "bg-blue-300";
          if(v > 20 && v <= 50) lvl = "bg-rain-base";
          if(v > 50 && v <= 90) lvl = "bg-rain-dark";
          if(v > 90) lvl = "bg-good-base border-2 border-yellow-400";

          return `<div class="heatmap-cell ${lvl} text-white" title="${formatDate(day.date)}: ${Math.round(v)}mm">${day.dt.getDate()}</div>`;
        }).join("");

        container.innerHTML += `
          <div class="border border-slate-200 rounded-lg p-3">
            <p class="text-xs font-bold text-slate-600 mb-2">${monthNames[b.month]} ${b.year}</p>
            <div class="grid grid-cols-7 gap-1">${daysHtml}</div>
          </div>
        `;
      });
    }

    // ============================================================
    // 8) TABELA
    // ============================================================
    function renderTable(){
      let arr;
      const hint = document.getElementById("tableHint");

      if(state.selectedSeasons.length){
        const set = new Set(state.selectedSeasons);
        arr = state.data.filter(r => r.kind === "daily" && set.has(r.season));
        hint.textContent = `Filtro: Safras ${state.selectedSeasons.join(", ")}`;
      } else {
        arr = state.data.filter(r => r.kind === "daily");
        hint.textContent = "Filtro: Todos os registros";
      }

      arr = arr.sort((a,b) => new Date(b.date + "T00:00:00") - new Date(a.date + "T00:00:00"))
               .slice(0, 120);

      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = arr.map(d => `
        <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
          <td class="px-4 py-3 text-sm">${formatDate(d.date)}</td>
          <td class="px-4 py-3 text-sm text-center font-bold text-rain-base">${formatNumber(d.value)} mm</td>
          <td class="px-4 py-3 text-sm text-center"><span class="text-xs px-2 py-1 bg-blue-100 text-blue-900 rounded-full font-bold">${d.season}</span></td>
        </tr>
      `).join("") || `<tr><td colspan="3" class="px-4 py-6 text-center text-sm text-slate-500">Sem registros</td></tr>`;
    }

    // ============================================================
    // 9) MODO E REBUILD
    // ============================================================
    function renderByMode(){
      const cardChart = document.getElementById("cardChart");
      const cardHeatmap = document.getElementById("cardHeatmap");

      cardChart.classList.remove("hidden");
      cardHeatmap.classList.add("hidden");

      if(state.viewMode === "annual"){
        renderAnnualChart();
      } else if(state.viewMode === "monthly"){
        renderMonthlyChart();
      } else if(state.viewMode === "daily"){
        renderDailyChart();
      } else if(state.viewMode === "calendar"){
        cardHeatmap.classList.remove("hidden");
        renderDailyChart();
        renderHeatmap();
        document.getElementById("chartTitle").textContent = "üìÖ Calend√°rio + Contexto";
      }
    }

    function rebuild(){
      renderSeasonChips();
      renderKPIs();
      renderByMode();
      renderTable();
      renderAlerts();

      // Update mode hints
      const modeEl = document.querySelector('input[name="viewMode"]:checked');
      if(modeEl){
        if(modeEl.id === "modeDaily" || modeEl.id === "modeCalendar"){
          state.viewMode = modeEl.id === "modeDaily" ? "daily" : "calendar";
          if(state.selectedSeasons.length === 0){
            document.getElementById("modeHint").textContent = "‚ö†Ô∏è Selecione 1 safra para esta vis√£o";
          }
        } else if(modeEl.id === "modeMonthly"){
          state.viewMode = "monthly";
          if(state.selectedSeasons.length === 0){
            document.getElementById("modeHint").textContent = "‚ö†Ô∏è Selecione at√© 4 safras";
          }
        } else {
          state.viewMode = "annual";
        }
      }
    }

    // ============================================================
    // 10) ADICIONAR REGISTRO
    // ============================================================
    function addRecord(){
      const date = document.getElementById("addDate").value;
      const value = Number(document.getElementById("addValue").value);
      const season = document.getElementById("addSeason").value.trim();

      if(!date || !isValidISODate(date)){
        showToast("‚ùå Data inv√°lida");
        return;
      }
      if(!season || !/^\d{4}$/.test(season)){
        showToast("‚ùå Safra deve ser um ano (AAAA)");
        return;
      }
      if(Number.isNaN(value) || value < 0){
        showToast("‚ùå Volume inv√°lido");
        return;
      }

      const extra = loadExtra();
      extra.push({ date, value, season });
      saveExtra(extra);

      state.data = loadData();
      invalidateCache();
      rebuild();
      closeAddModal();
      showToast("‚úÖ Registro salvo com sucesso");
    }

    // ============================================================
    // 11) IMPORTA√á√ÉO/EXPORTA√á√ÉO CSV
    // ============================================================
    function toCSV(rows){
      const header = ["date","value","season"];
      const lines = [header.join(",")];
      rows.forEach(r => {
        lines.push([String(r.date), String(r.value), String(r.season)].join(","));
      });
      return lines.join("\n");
    }

    function exportCSV(){
      const extra = loadExtra();
      if(extra.length === 0){
        showToast("‚ö†Ô∏è Sem registros para exportar");
        return;
      }
      const csv = toCSV(extra);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "fazenda_cacimbas_registros.csv";
      a.click();
      URL.revokeObjectURL(url);
      showToast("‚úÖ CSV exportado");
    }

    function parseCSV(text){
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if(lines.length < 2) return [];

      const header = lines[0].split(",").map(h => h.trim().toLowerCase());
      const idxDate = header.indexOf("date");
      const idxValue = header.indexOf("value");
      const idxSeason = header.indexOf("season");

      if(idxDate < 0 || idxValue < 0 || idxSeason < 0) return [];

      const out = [];
      for(let i = 1; i < Math.min(lines.length, 5001); i++){
        const parts = lines[i].split(",").map(p => p.trim());
        const date = parts[idxDate];
        const value = Number(parts[idxValue]);
        const season = parts[idxSeason];

        if(!isValidISODate(date)) continue;
        if(!/^\d{4}$/.test(season)) continue;
        if(Number.isNaN(value) || value < 0) continue;

        out.push({ date, value, season });
      }
      return out;
    }

    function importCSV(event){
      const file = event.target.files?.[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        const text = String(reader.result || "");
        const rows = parseCSV(text);

        if(rows.length === 0){
          showToast("‚ùå CSV inv√°lido");
          return;
        }

        const current = loadExtra();
        const merged = [...current, ...rows];

        const map = new Map();
        merged.forEach(r => {
          const k = `${r.season}__${r.date}`;
          if(!map.has(k)){
            map.set(k, { ...r });
          } else {
            const ex = map.get(k);
            ex.value += r.value;
            map.set(k, ex);
          }
        });

        saveExtra(Array.from(map.values()));
        state.data = loadData();
        invalidateCache();
        rebuild();
        showToast(`‚úÖ ${rows.length} registros importados`);
      };
      reader.readAsText(file);
      event.target.value = "";
    }

    // ============================================================
    // 12) INICIALIZA√á√ÉO
    // ============================================================
    window.addEventListener("load", () => {
      document.getElementById("currentDate").textContent = 
        new Date().toLocaleDateString("pt-BR", { weekday: "long", day: "numeric", month: "long", year: "numeric" });

      state.data = loadData();
      const totals = annualTotals();
      if(totals.length){
        state.selectedSeasons = [totals[totals.length-1].season];
      }

      // Event listeners para modo
      ["modeAnnual", "modeMonthly", "modeDaily", "modeCalendar"].forEach(id => {
        document.getElementById(id).addEventListener("change", () => {
          state.viewMode = {
            modeAnnual: "annual",
            modeMonthly: "monthly",
            modeDaily: "daily",
            modeCalendar: "calendar"
          }[id];
          invalidateCache();
          rebuild();
        });
      });

      // Fechar modal ao pressionar Esc
      document.addEventListener("keydown", (e) => {
        if(e.key === "Escape") closeAddModal();
      });

      rebuild();
    });
  </script>
</body>
</html>
