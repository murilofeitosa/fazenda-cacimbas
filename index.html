<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fazenda Cacimbas - Controle de Chuvas</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary-blue: #2563eb;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --danger-red: #ef4444;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        body {
            background: var(--bg-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header-section {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.2);
        }
        
        .logo-img {
            width: 60px;
            margin-right: 1rem;
            filter: brightness(0) invert(1);
        }
        
        /* Cards */
        .glass-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        .glass-card:hover { transform: translateY(-2px); }

        /* KPIs */
        .kpi-card {
            border-left: 5px solid var(--primary-blue);
            height: 100%;
        }
        .kpi-value { font-size: 2.2rem; font-weight: 800; color: var(--primary-blue); line-height: 1.2; }
        .kpi-label { font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Filtros */
        .filter-section {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            box-shadow: var(--card-shadow);
        }
        .filter-btn {
            border: 1px solid var(--border-color);
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        /* Mapa de Calor */
        .heatmap-wrapper { display: flex; flex-wrap: wrap; gap: 10px; max-height: 400px; overflow-y: auto; }
        .month-block { background: #f1f5f9; border-radius: 8px; padding: 10px; flex: 1 1 180px; }
        .month-title { font-size: 0.8rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; }
        .days-grid { display: flex; flex-wrap: wrap; gap: 4px; }
        .rain-day {
            width: 28px; height: 28px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 700; color: white; cursor: pointer;
        }
        .rain-day:hover { transform: scale(1.2); }
        
        /* Cores */
        .lvl-1 { background: #93c5fd; }
        .lvl-2 { background: #3b82f6; }
        .lvl-3 { background: #1d4ed8; }
        .lvl-4 { background: #1e3a8a; border: 2px solid #fbbf24; }

        /* Tabela */
        .table-modern th { background: #f1f5f9; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        .badge-safra { background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }

        /* Footer */
        .footer {
            margin-top: auto;
            background: var(--bg-secondary);
            padding: 1.5rem 0;
            text-align: center;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Radar Iframe */
        .radar-container {
            width: 100%;
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            display: none; /* Oculto por padrão */
        }
    </style>
</head>
<body>

    <div class="header-section">
        <div class="container d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <img src="https://cdn-icons-png.flaticon.com/512/2830/2830227.png" alt="Logo" class="logo-img">
                <div>
                    <h1 class="h3 fw-bold mb-0">Fazenda Cacimbas</h1>
                    <p class="mb-0 opacity-75">Controle de Chuvas</p>
                </div>
            </div>
            <div class="text-end d-none d-md-block">
                <div class="h5 fw-bold mb-0" id="currentDate"></div>
                <small class="opacity-75">Monitoramento Inteligente</small>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        
        <div class="mb-4">
            <button class="btn btn-outline-primary w-100 fw-bold" type="button" onclick="toggleRadar()">
                <i class="fas fa-satellite-dish me-2"></i> Abrir Radar de Chuvas (FUNCEME)
            </button>
            <div id="radarBox" class="radar-container mt-3">
                <iframe src="https://radar.funceme.br/radar-mini" width="100%" height="100%" style="border:0;"></iframe>
            </div>
        </div>

        <div class="filter-section" id="filterContainer">
            </div>

        <div class="row g-3 mb-4" id="kpiContainer"></div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="glass-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0"><i class="fas fa-chart-line me-2 text-primary"></i>Evolução</h5>
                        <span class="badge bg-light text-dark border" id="chartLabel">Histórico</span>
                    </div>
                    <canvas id="comboChart" height="140"></canvas>
                </div>

                <div class="glass-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0"><i class="fas fa-calendar-alt me-2 text-primary"></i>Calendário</h5>
                        <small class="text-muted bg-light px-2 py-1 rounded">Nº = Dia do Mês</small>
                    </div>
                    <div id="heatmapContainer" class="heatmap-wrapper"></div>
                </div>
                
                <div class="glass-card">
                    <h5 class="fw-bold mb-3"><i class="fas fa-calculator me-2 text-primary"></i>Estatísticas</h5>
                    <div class="row text-center g-3" id="statsContainer"></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="glass-card">
                    <h5 class="fw-bold mb-3"><i class="fas fa-bullseye me-2 text-primary"></i>Padrão Mensal</h5>
                    <canvas id="radarChart" height="250"></canvas>
                </div>

                <div class="glass-card" style="height: 600px; display: flex; flex-direction: column;">
                    <h5 class="fw-bold mb-3"><i class="fas fa-list me-2 text-primary"></i>Registros</h5>
                    <div class="flex-grow-1 overflow-auto">
                        <table class="table table-modern table-hover mb-0">
                            <thead class="sticky-top">
                                <tr>
                                    <th>Data</th>
                                    <th>Vol.</th>
                                    <th>Inverno</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p class="mb-0">Desenvolvido por <strong>Murilo Feitosa</strong></p>
            <small>Fazenda Cacimbas &copy; 2026</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- 1. BASE DE DADOS COMPLETA ---
        const rawData = [
            // --- DADOS HISTÓRICOS (TOTAIS) ---
            // Nota: Lançados em 01/Jan para contabilidade. Substituir por detalhados futuramente.
            { date: '2013-01-01', value: 312, season: '2013' },
            { date: '2014-01-01', value: 499, season: '2014' },
            { date: '2015-01-01', value: 478, season: '2015' },
            { date: '2016-01-01', value: 605, season: '2016' },
            { date: '2017-01-01', value: 352, season: '2017' },
            { date: '2018-01-01', value: 430, season: '2018' },
            { date: '2019-01-01', value: 712, season: '2019' },
            { date: '2020-01-01', value: 898, season: '2020' },
            { date: '2021-01-01', value: 609, season: '2021' },
            { date: '2022-01-01', value: 595, season: '2022' },

            // --- INVERNO 2024 (DETALHADO) ---
            { date: '2023-11-06', value: 6, season: '2024' },
            { date: '2023-11-28', value: 8, season: '2024' },
            { date: '2023-12-18', value: 9, season: '2024' },
            { date: '2023-12-20', value: 48, season: '2024' },
            { date: '2023-12-21', value: 10, season: '2024' },
            { date: '2024-01-12', value: 20, season: '2024' },
            { date: '2024-02-09', value: 9, season: '2024' },
            { date: '2024-02-11', value: 20, season: '2024' },
            { date: '2024-02-13', value: 11, season: '2024' },
            { date: '2024-02-18', value: 39, season: '2024' },
            { date: '2024-02-21', value: 59, season: '2024' },
            { date: '2024-02-27', value: 28, season: '2024' },
            { date: '2024-02-28', value: 30, season: '2024' },
            { date: '2024-03-01', value: 8, season: '2024' },
            { date: '2024-03-04', value: 8, season: '2024' },
            { date: '2024-03-05', value: 16, season: '2024' },
            { date: '2024-03-13', value: 19, season: '2024' },
            { date: '2024-03-27', value: 19, season: '2024' },
            { date: '2024-03-30', value: 21, season: '2024' },
            { date: '2024-03-31', value: 110, season: '2024' },
            { date: '2024-04-02', value: 11, season: '2024' },
            { date: '2024-04-03', value: 5, season: '2024' },
            { date: '2024-04-10', value: 32, season: '2024' },
            { date: '2024-04-11', value: 2, season: '2024' },
            { date: '2024-04-12', value: 14, season: '2024' },
            { date: '2024-04-14', value: 3, season: '2024' },
            { date: '2024-04-15', value: 11, season: '2024' },
            { date: '2024-04-16', value: 6, season: '2024' },
            { date: '2024-04-20', value: 5, season: '2024' },
            { date: '2024-04-21', value: 23, season: '2024' },
            { date: '2024-04-22', value: 11, season: '2024' },

            // --- INVERNO 2025 (DETALHADO) ---
            { date: '2024-12-03', value: 40, season: '2025' },
            { date: '2025-01-13', value: 14, season: '2025' },
            { date: '2025-01-14', value: 105, season: '2025' },
            { date: '2025-01-15', value: 34, season: '2025' },
            { date: '2025-01-20', value: 95, season: '2025' },
            { date: '2025-01-23', value: 10, season: '2025' },
            { date: '2025-02-17', value: 11, season: '2025' },
            { date: '2025-02-19', value: 22, season: '2025' },
            { date: '2025-02-24', value: 34, season: '2025' },
            { date: '2025-02-28', value: 50, season: '2025' },
            { date: '2025-03-01', value: 56, season: '2025' },
            { date: '2025-03-03', value: 10, season: '2025' },
            { date: '2025-03-04', value: 30, season: '2025' },
            { date: '2025-03-06', value: 6, season: '2025' },
            { date: '2025-03-07', value: 100, season: '2025' },
            { date: '2025-03-08', value: 24, season: '2025' },
            { date: '2025-03-11', value: 5, season: '2025' },
            { date: '2025-03-17', value: 9, season: '2025' },
            { date: '2025-03-18', value: 77, season: '2025' },
            { date: '2025-03-22', value: 9, season: '2025' },
            { date: '2025-03-28', value: 40, season: '2025' },
            { date: '2025-04-02', value: 10, season: '2025' },
            { date: '2025-04-22', value: 19, season: '2025' },
            { date: '2025-05-05', value: 11, season: '2025' },
            { date: '2025-05-10', value: 10, season: '2025' },
            { date: '2025-05-21', value: 9, season: '2025' },

            // --- INVERNO 2026 (DETALHADO) ---
            { date: '2025-10-21', value: 20, season: '2026' },
            { date: '2025-12-22', value: 55, season: '2026' },
            { date: '2025-12-23', value: 18, season: '2026' },
            { date: '2026-01-21', value: 7, season: '2026' },
            { date: '2026-01-27', value: 59, season: '2026' },
            { date: '2026-01-29', value: 40, season: '2026' },
            { date: '2026-02-05', value: 20, season: '2026' },
            { date: '2026-02-07', value: 8, season: '2026' }
        ];

        // --- 2. CONFIGURAÇÕES GERAIS ---
        const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        let chartCombo = null;
        let chartRadar = null;

        // --- 3. FUNÇÃO DE RADAR (TOGGLE) ---
        function toggleRadar() {
            const box = document.getElementById('radarBox');
            box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'block' : 'none';
        }

        // --- 4. GERAR BOTÕES DE FILTRO AUTOMATICAMENTE ---
        function gerarBotoes() {
            const container = document.getElementById('filterContainer');
            // Extrair anos únicos dos dados e ordenar reverso
            const seasons = [...new Set(rawData.map(d => d.season))].sort().reverse();
            
            // Botão "Todos"
            let html = '<button class="filter-btn active" onclick="filtrarDados(\'all\', this)">Todos</button>';
            
            // Botão "Comparar"
            html += '<button class="filter-btn" onclick="filtrarDados(\'compare\', this)">Comparar Safras</button>';
            
            // Botões por Ano
            seasons.forEach(year => {
                html += `<button class="filter-btn" onclick="filtrarDados('${year}', this)">${year}</button>`;
            });
            
            container.innerHTML = html;
        }

        // --- 5. FILTRAGEM ---
        function filtrarDados(filtro, btnElement) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            if(filtro === 'compare') {
                // Modo comparação (pode ser implementado futuramente para gráficos multi-linha)
                // Por enquanto, mostra todos para não quebrar a visualização
                filtro = 'all';
                alert("Modo Comparação: Exibindo visão geral de todos os invernos.");
            }

            let dadosFiltrados;
            if (filtro === 'all') {
                dadosFiltrados = [...rawData];
                document.getElementById('chartLabel').textContent = "Histórico Completo";
            } else {
                dadosFiltrados = rawData.filter(d => d.season === filtro);
                document.getElementById('chartLabel').textContent = `Inverno ${filtro}`;
            }

            // Ordenações
            const sorted = [...dadosFiltrados].sort((a, b) => new Date(a.date) - new Date(b.date));
            const reversed = [...dadosFiltrados].sort((a, b) => new Date(b.date) - new Date(a.date));

            // Execuções
            renderKPIs(rawData); // KPIs mostram sempre o geral
            renderCharts(sorted);
            renderStats(dadosFiltrados);
            renderHeatmap(sorted);
            renderTable(reversed);
        }

        // --- 6. RENDERIZADORES ---
        
        function renderKPIs(dados) {
            const seasonTotals = {};
            dados.forEach(d => seasonTotals[d.season] = (seasonTotals[d.season] || 0) + d.value);
            const container = document.getElementById('kpiContainer');
            container.innerHTML = '';

            // Mostrar apenas os 4 mais recentes no topo para não poluir
            Object.keys(seasonTotals).sort().reverse().slice(0, 4).forEach(season => {
                container.innerHTML += `
                    <div class="col-6 col-lg-3">
                        <div class="glass-card kpi-card py-3">
                            <div class="kpi-label">Inverno ${season}</div>
                            <div class="kpi-value">${seasonTotals[season]} <small class="fs-6 text-muted">mm</small></div>
                        </div>
                    </div>
                `;
            });
        }

        function renderCharts(dados) {
            // Combo Chart
            const labels = dados.map(d => new Date(d.date).toLocaleDateString('pt-BR').slice(0,5));
            const values = dados.map(d => d.value);
            let acc = 0;
            const accumulated = dados.map(d => { acc += d.value; return acc; });

            if(chartCombo) chartCombo.destroy();
            chartCombo = new Chart(document.getElementById('comboChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Chuva (mm)', data: values, backgroundColor: '#2563eb', borderRadius: 3, order: 2, yAxisID: 'y' },
                        { type: 'line', label: 'Acumulado', data: accumulated, borderColor: '#10b981', borderWidth: 2, pointRadius: 0, tension: 0.3, order: 1, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { display: false },
                        y: { display: true, position: 'left' },
                        y1: { display: true, position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });

            // Radar Chart (Médias)
            const monthSums = Array(12).fill(0);
            const monthCounts = Array(12).fill(0);
            dados.forEach(d => {
                const m = new Date(d.date).getMonth();
                monthSums[m] += d.value;
                monthCounts[m]++;
            });
            const avgs = monthSums.map((s, i) => monthCounts[i] ? s / monthCounts[i] : 0);

            if(chartRadar) chartRadar.destroy();
            chartRadar = new Chart(document.getElementById('radarChart'), {
                type: 'radar',
                data: {
                    labels: monthNames,
                    datasets: [{
                        label: 'Média (mm)',
                        data: avgs,
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                        borderColor: '#2563eb',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { r: { suggestedMin: 0, ticks: { display: false } } }
                }
            });
        }

        function renderHeatmap(dados) {
            const container = document.getElementById('heatmapContainer');
            container.innerHTML = '';
            
            const grouped = {};
            // Filtrar apenas dados RECENTES (últimos 3 anos) se for visualização "Todos" para não travar
            // Se for filtro específico, mostra tudo daquele ano
            const dadosParaHeatmap = dados.length > 500 ? dados.slice(-365) : dados;

            [...dadosParaHeatmap].reverse().forEach(d => {
                const date = new Date(d.date);
                const key = `${date.getMonth()}-${date.getFullYear()}`;
                if(!grouped[key]) {
                    grouped[key] = { name: monthNames[date.getMonth()], year: date.getFullYear(), days: [] };
                }
                grouped[key].days.push(d);
            });

            Object.values(grouped).forEach(g => {
                g.days.sort((a,b) => new Date(a.date) - new Date(b.date));
                let daysHtml = '';
                g.days.forEach(day => {
                    let lvl = 'lvl-1';
                    if(day.value > 20) lvl = 'lvl-2';
                    if(day.value > 50) lvl = 'lvl-3';
                    if(day.value > 90) lvl = 'lvl-4';
                    daysHtml += `<div class="rain-day ${lvl}" title="${new Date(day.date).toLocaleDateString('pt-BR')}: ${day.value}mm">${new Date(day.date).getDate()}</div>`;
                });
                container.innerHTML += `
                    <div class="month-block">
                        <div class="month-title">${g.name} ${g.year}</div>
                        <div class="days-grid">${daysHtml}</div>
                    </div>
                `;
            });
        }

        function renderStats(dados) {
            const values = dados.map(d => d.value).sort((a,b) => a-b);
            if(values.length === 0) return;
            
            const total = values.reduce((a,b) => a+b, 0);
            const media = total / values.length;
            const max = values[values.length-1];
            
            document.getElementById('statsContainer').innerHTML = `
                <div class="col-4">
                    <div class="p-2 border rounded bg-white">
                        <div class="h4 fw-bold text-primary mb-0">${values.length}</div>
                        <small class="text-muted">Dias</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2 border rounded bg-white">
                        <div class="h4 fw-bold text-primary mb-0">${media.toFixed(0)}</div>
                        <small class="text-muted">Média (mm)</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2 border rounded bg-white">
                        <div class="h4 fw-bold text-danger mb-0">${max}</div>
                        <small class="text-muted">Máxima</small>
                    </div>
                </div>
            `;
        }

        function renderTable(dados) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            // Limitar a 50 linhas para não pesar se for "Todos"
            const dadosTabela = dados.slice(0, 100); 
            
            dadosTabela.forEach(d => {
                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(d.date).toLocaleDateString('pt-BR')}</td>
                        <td><strong>${d.value} mm</strong></td>
                        <td><span class="badge-safra">${d.season}</span></td>
                    </tr>
                `;
            });
        }

        // Inicialização
        window.onload = function() {
            gerarBotoes();
            filtrarDados('all');
        }
    </script>
</body>
</html>
