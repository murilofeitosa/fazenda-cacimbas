<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Pluviom√©trico - Fazenda Cacimbas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; box-shadow: 0 2px 15px rgba(0,0,0,0.05); border-radius: 12px; margin-bottom: 20px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: 700; color: #2c3e50; border-radius: 12px 12px 0 0 !important; padding: 15px 20px; }
        .metric-value { font-size: 2.2em; font-weight: 800; color: #2980b9; }
        .metric-label { color: #95a5a6; text-transform: uppercase; font-size: 0.75em; letter-spacing: 1.2px; font-weight: 600; }
        .status-badge { padding: 6px 12px; border-radius: 30px; font-size: 0.85em; font-weight: 600; }
        .status-good { background-color: #d4edda; color: #155724; }
        .status-warning { background-color: #fff3cd; color: #856404; }
        .status-bad { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">üåßÔ∏è Fazenda Cacimbas</h2>
        <span class="text-muted" id="current-date"></span>
    </div>

    <div class="row" id="season-cards">
        </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-white">
                <div class="card-body d-flex align-items-center justify-content-between flex-wrap">
                    <div>
                        <h5 class="card-title mb-1">Status do M√™s Atual (<span id="lbl-current-month"></span>)</h5>
                        <p class="text-muted small mb-0">Comparativo com a m√©dia hist√≥rica</p>
                    </div>
                    <div class="text-end">
                        <div class="fs-4 fw-bold" id="current-month-val">0 mm</div>
                        <div class="small text-muted">Acumulado</div>
                    </div>
                    <div class="text-end border-start ps-4 ms-2">
                        <div class="fs-4 fw-bold text-secondary" id="hist-avg-val">0 mm</div>
                        <div class="small text-muted">M√©dia Hist√≥rica</div>
                    </div>
                    <div class="ms-3">
                        <span id="month-performance-badge" class="status-badge">Calculando...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>M√©dia Hist√≥rica Mensal</span>
                    <small class="text-muted fw-normal">Padr√£o de chuvas da fazenda</small>
                </div>
                <div class="card-body">
                    <canvas id="avgChart" height="120"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Evolu√ß√£o dos Registros</div>
                <div class="card-body">
                    <canvas id="historyChart" height="150"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">√öltimos Lan√ßamentos</div>
                <div class="card-body p-0" style="overflow-y: auto; max-height: 600px;">
                    <table class="table table-hover table-striped mb-0 text-center">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Data</th>
                                <th>Chuva (mm)</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. DADOS (Adicione seus dados antigos aqui) ---
    const rawData = [
        // Inverno 2025
        { date: '2024-12-03', value: 40, season: '2025' },
        { date: '2025-01-13', value: 14, season: '2025' },
        { date: '2025-01-14', value: 105, season: '2025' },
        { date: '2025-01-15', value: 34, season: '2025' },
        { date: '2025-01-20', value: 95, season: '2025' },
        { date: '2025-01-23', value: 10, season: '2025' },
        { date: '2025-02-17', value: 11, season: '2025' },
        { date: '2025-02-19', value: 22, season: '2025' },
        { date: '2025-02-24', value: 34, season: '2025' },
        { date: '2025-02-28', value: 50, season: '2025' },
        { date: '2025-03-01', value: 56, season: '2025' },
        { date: '2025-03-03', value: 10, season: '2025' },
        { date: '2025-03-04', value: 30, season: '2025' },
        { date: '2025-03-06', value: 6, season: '2025' },
        { date: '2025-03-07', value: 100, season: '2025' },
        { date: '2025-03-08', value: 24, season: '2025' },
        { date: '2025-03-11', value: 5, season: '2025' },
        { date: '2025-03-17', value: 9, season: '2025' },
        { date: '2025-03-18', value: 77, season: '2025' },
        { date: '2025-03-22', value: 9, season: '2025' },
        { date: '2025-03-28', value: 40, season: '2025' },
        { date: '2025-04-02', value: 10, season: '2025' },
        { date: '2025-04-22', value: 19, season: '2025' },
        { date: '2025-05-05', value: 11, season: '2025' },
        { date: '2025-05-10', value: 10, season: '2025' },
        { date: '2025-05-21', value: 9, season: '2025' },

        // Inverno 2026
        { date: '2025-10-21', value: 20, season: '2026' },
        { date: '2025-12-22', value: 55, season: '2026' },
        { date: '2025-12-23', value: 18, season: '2026' },
        { date: '2026-01-21', value: 7, season: '2026' },
        { date: '2026-01-27', value: 59, season: '2026' },
        { date: '2026-01-29', value: 40, season: '2026' },
        { date: '2026-02-05', value: 20, season: '2026' },
        { date: '2026-02-07', value: 8, season: '2026' }
    ];

    // Configura√ß√µes
    const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('pt-BR');

    // --- 2. PROCESSAMENTO DE DADOS ---

    // Ordenar dados (Recente -> Antigo) para tabela
    const sortedData = [...rawData].sort((a, b) => new Date(b.date) - new Date(a.date));
    // Ordenar dados (Antigo -> Recente) para gr√°ficos
    const chartData = [...rawData].sort((a, b) => new Date(a.date) - new Date(b.date));

    // A. Calcular Totais por Temporada
    const seasonTotals = {};
    rawData.forEach(d => {
        seasonTotals[d.season] = (seasonTotals[d.season] || 0) + d.value;
    });

    // B. Calcular M√©dia Hist√≥rica Mensal
    // Passo 1: Agrupar totais por "M√™s-Ano" (Ex: Jan/2025 = 200mm, Jan/2026 = 100mm)
    const monthlyYearlyTotals = {};
    rawData.forEach(d => {
        const date = new Date(d.date);
        const key = `${date.getMonth()}-${date.getFullYear()}`; // Ex: "0-2025" para Jan 2025
        if (!monthlyYearlyTotals[key]) monthlyYearlyTotals[key] = { month: date.getMonth(), total: 0 };
        monthlyYearlyTotals[key].total += d.value;
    });

    // Passo 2: Calcular a m√©dia para cada m√™s (0 a 11)
    const monthSums = Array(12).fill(0);
    const monthCounts = Array(12).fill(0);

    Object.values(monthlyYearlyTotals).forEach(item => {
        monthSums[item.month] += item.total;
        monthCounts[item.month] += 1;
    });

    const monthlyAverages = monthSums.map((sum, i) => monthCounts[i] ? Math.round(sum / monthCounts[i]) : 0);


    // C. Calcular Status do M√™s Atual
    const today = new Date();
    // PARA TESTE: Vamos simular que estamos em Fevereiro de 2026 (pois √© o √∫ltimo dado relevante)
    // Se quiser usar a data real do computador, use: const currentMonthIndex = today.getMonth(); const currentYear = today.getFullYear();
    // Como os dados v√£o at√© Fev/2026, vamos fixar o "M√™s Atual" como Fevereiro de 2026 para demonstra√ß√£o:
    const currentMonthIndex = 1; // Fevereiro (0 = Jan, 1 = Fev)
    const currentYear = 2026; 
    
    // Calcular acumulado do m√™s "atual"
    let currentMonthTotal = 0;
    rawData.forEach(d => {
        const date = new Date(d.date);
        if (date.getMonth() === currentMonthIndex && date.getFullYear() === currentYear) {
            currentMonthTotal += d.value;
        }
    });

    const avgForCurrentMonth = monthlyAverages[currentMonthIndex];
    
    // --- 3. RENDERIZA√á√ÉO ---

    // A. Renderizar Cards de Temporada
    const seasonContainer = document.getElementById('season-cards');
    Object.keys(seasonTotals).sort().reverse().forEach(season => {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-3';
        col.innerHTML = `
            <div class="card p-3">
                <div class="metric-label">Inverno ${season}</div>
                <div class="metric-value">${seasonTotals[season]} <span style="font-size:0.5em; color:#bdc3c7">mm</span></div>
            </div>
        `;
        seasonContainer.appendChild(col);
    });

    // B. Renderizar Status do M√™s
    document.getElementById('lbl-current-month').textContent = `${monthNames[currentMonthIndex]} ${currentYear}`;
    document.getElementById('current-month-val').textContent = `${currentMonthTotal} mm`;
    document.getElementById('hist-avg-val').textContent = `${avgForCurrentMonth} mm`;
    
    const badge = document.getElementById('month-performance-badge');
    if (avgForCurrentMonth > 0) {
        const percentage = (currentMonthTotal / avgForCurrentMonth) * 100;
        if (percentage >= 100) {
            badge.textContent = `Acima da M√©dia (+${Math.round(percentage - 100)}%)`;
            badge.className = "status-badge status-good";
        } else if (percentage >= 70) {
            badge.textContent = `Dentro do Esperado (${Math.round(percentage)}%)`;
            badge.className = "status-badge status-warning";
        } else {
            badge.textContent = `Abaixo da M√©dia (${Math.round(percentage)}%)`;
            badge.className = "status-badge status-bad";
        }
    } else {
        badge.textContent = "Sem dados hist√≥ricos";
        badge.className = "status-badge bg-secondary text-white";
    }

    // C. Tabela de Dados
    const tableBody = document.getElementById('dataTableBody');
    sortedData.forEach(item => {
        tableBody.innerHTML += `
            <tr>
                <td>${new Date(item.date).toLocaleDateString('pt-BR')}</td>
                <td><strong>${item.value}</strong></td>
            </tr>
        `;
    });

    // D. Gr√°ficos (Chart.js)
    
    // 1. Gr√°fico de M√©dias (Barras)
    new Chart(document.getElementById('avgChart'), {
        type: 'bar',
        data: {
            labels: monthNames,
            datasets: [{
                label: 'M√©dia Hist√≥rica (mm)',
                data: monthlyAverages,
                backgroundColor: 'rgba(52, 152, 219, 0.6)',
                borderColor: 'rgba(52, 152, 219, 1)',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });

    // 2. Gr√°fico de Hist√≥rico (Linha)
    new Chart(document.getElementById('historyChart'), {
        type: 'line',
        data: {
            labels: chartData.map(d => new Date(d.date).toLocaleDateString('pt-BR').slice(0,5)), // Mostra s√≥ DD/MM
            datasets: [{
                label: 'Chuva Di√°ria',
                data: chartData.map(d => d.value),
                borderColor: '#e67e22',
                backgroundColor: 'rgba(230, 126, 34, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            elements: { point: { radius: 2 } }
        }
    });

</script>
</body>
</html>
