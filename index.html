```html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fazenda Cacimbas - Dashboard de Chuvas</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{
      --primary-blue:#2563eb;
      --success-green:#10b981;
      --warning-yellow:#f59e0b;
      --danger-red:#ef4444;
      --bg-primary:#f8fafc;
      --bg-secondary:#ffffff;
      --text-primary:#1e293b;
      --text-secondary:#64748b;
      --border-color:#e2e8f0;
      --card-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);
    }

    body{
      background:var(--bg-primary);
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color:var(--text-primary);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .header-section{
      background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);
      color:#fff;
      padding:1.6rem 0;
      margin-bottom:1.2rem;
      box-shadow:0 10px 15px -3px rgba(37,99,235,.2);
    }

    .logo-img{
      width:56px;
      margin-right:1rem;
      filter:brightness(0) invert(1);
    }

    .glass-card{
      background:var(--bg-secondary);
      border-radius:16px;
      padding:1.2rem;
      box-shadow:var(--card-shadow);
      border:1px solid var(--border-color);
      margin-bottom:1rem;
    }

    .kpi-value{ font-size:2rem; font-weight:800; color:var(--primary-blue); line-height:1.1; }
    .kpi-label{ font-size:.78rem; font-weight:800; color:var(--text-secondary); text-transform:uppercase; letter-spacing:.6px; }
    .kpi-sub{ font-size:.85rem; color:var(--text-secondary); }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      padding:.35rem .7rem;
      border-radius:999px;
      border:1px solid var(--border-color);
      background:#fff;
      font-weight:700;
      font-size:.9rem;
      cursor:pointer;
      user-select:none;
      transition:all .15s;
    }
    .chip.active{ background:var(--primary-blue); border-color:var(--primary-blue); color:#fff; }
    .chip:focus{ outline:2px solid rgba(37,99,235,.25); outline-offset:2px; }

    .radar-container{
      width:100%;
      height:500px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid var(--border-color);
      display:none;
    }

    .heatmap-wrapper{ display:flex; flex-wrap:wrap; gap:10px; max-height:420px; overflow:auto; }
    .month-block{ background:#f1f5f9; border-radius:10px; padding:10px; flex:1 1 200px; }
    .month-title{ font-size:.78rem; font-weight:900; color:var(--text-secondary); margin-bottom:8px; text-transform:uppercase; }
    .days-grid{ display:flex; flex-wrap:wrap; gap:4px; }
    .rain-day{
      width:28px; height:28px; border-radius:6px;
      display:flex; align-items:center; justify-content:center;
      font-size:.7rem; font-weight:800; color:#fff;
    }
    .lvl-0{ background:#cbd5e1; color:#0f172a; }
    .lvl-1{ background:#93c5fd; }
    .lvl-2{ background:#3b82f6; }
    .lvl-3{ background:#1d4ed8; }
    .lvl-4{ background:#1e3a8a; border:2px solid #fbbf24; }

    .table-modern th{ background:#f1f5f9; text-transform:uppercase; font-size:.75rem; letter-spacing:.6px; }
    .badge-safra{ background:#dbeafe; color:#1e40af; padding:4px 10px; border-radius:999px; font-size:.75rem; font-weight:900; }
    .badge-good{ background:#dcfce7; color:#166534; }
    .badge-bad{ background:#fee2e2; color:#991b1b; }
    .badge-mid{ background:#e2e8f0; color:#0f172a; }

    .footer{
      margin-top:auto;
      background:var(--bg-secondary);
      padding:1.2rem 0;
      text-align:center;
      border-top:1px solid var(--border-color);
      font-size:.9rem;
      color:var(--text-secondary);
    }

    /* Garante altura do chart para não “sumir” em alguns layouts */
    .chart-box{ height: 360px; }
    @media (max-width: 576px){
      .chart-box{ height: 320px; }
    }
  </style>
</head>

<body>
  <div class="header-section">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <img src="https://cdn-icons-png.flaticon.com/512/2830/2830227.png" alt="Logo" class="logo-img">
        <div>
          <h1 class="h3 fw-bold mb-0">Fazenda Cacimbas</h1>
          <p class="mb-0 opacity-75">Dashboard de Chuvas e Safras</p>
        </div>
      </div>
      <div class="text-end d-none d-md-block">
        <div class="h6 fw-bold mb-0" id="currentDate"></div>
        <small class="opacity-75">Visão por ciclo, comparação e histórico</small>
      </div>
    </div>
  </div>

  <div class="container pb-5">
    <div class="row g-3 align-items-stretch mb-2">
      <div class="col-lg-8">
        <div class="glass-card h-100">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div>
              <div class="fw-bold"><i class="fa-solid fa-sliders me-2 text-primary"></i>Seleção</div>
              <div class="text-muted small">
                Selecione 1 safra para Diário/Calendário. Selecione até 4 para comparar no Mensal/Anual.
              </div>
            </div>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-outline-primary fw-bold" data-bs-toggle="modal" data-bs-target="#modalAdd">
                <i class="fa-solid fa-plus me-2"></i>Novo registro
              </button>
              <button class="btn btn-outline-primary fw-bold" type="button" onclick="toggleRadar()">
                <i class="fa-solid fa-satellite-dish me-2"></i>Radar FUNCEME
              </button>
              <div class="btn-group">
                <button class="btn btn-outline-secondary fw-bold" type="button" onclick="exportCSV()">
                  <i class="fa-solid fa-file-export me-2"></i>Exportar CSV
                </button>
                <label class="btn btn-outline-secondary fw-bold mb-0">
                  <i class="fa-solid fa-file-import me-2"></i>Importar CSV
                  <input type="file" accept=".csv" hidden onchange="importCSV(event)">
                </label>
              </div>
            </div>
          </div>

          <div class="radar-container mt-3" id="radarBox">
            <iframe src="https://radar.funceme.br/radar-mini" width="100%" height="100%" style="border:0;"></iframe>
          </div>

          <hr class="my-3">

          <div class="d-flex flex-wrap gap-2 align-items-center">
            <span class="small text-muted fw-bold">Ações:</span>
            <button class="btn btn-sm btn-light border" type="button" onclick="selectPreset('last')">Última safra</button>
            <button class="btn btn-sm btn-light border" type="button" onclick="selectPreset('best')">Melhor safra</button>
            <button class="btn btn-sm btn-light border" type="button" onclick="selectPreset('worst')">Pior safra</button>
            <button class="btn btn-sm btn-light border" type="button" onclick="selectPreset('clear')">Limpar seleção</button>
          </div>

          <div class="mt-3" id="seasonChips" aria-label="Seleção de safras"></div>

          <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
            <span class="small text-muted fw-bold">Modo:</span>
            <div class="btn-group" role="group" aria-label="Modo de visualização">
              <input type="radio" class="btn-check" name="viewMode" id="modeAnnual" autocomplete="off" checked>
              <label class="btn btn-outline-primary" for="modeAnnual">Anual</label>

              <input type="radio" class="btn-check" name="viewMode" id="modeMonthly" autocomplete="off">
              <label class="btn btn-outline-primary" for="modeMonthly">Mensal</label>

              <input type="radio" class="btn-check" name="viewMode" id="modeDaily" autocomplete="off">
              <label class="btn btn-outline-primary" for="modeDaily">Diário</label>

              <input type="radio" class="btn-check" name="viewMode" id="modeCalendar" autocomplete="off">
              <label class="btn btn-outline-primary" for="modeCalendar">Calendário</label>
            </div>

            <span class="ms-auto small text-muted" id="modeHint"></span>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="glass-card h-100">
          <div class="fw-bold mb-2"><i class="fa-solid fa-gauge-high me-2 text-primary"></i>Indicadores</div>
          <div class="row g-2" id="kpiContainer"></div>
          <hr class="my-3">
          <div class="fw-bold mb-2"><i class="fa-solid fa-ranking-star me-2 text-primary"></i>Classificação</div>
          <div class="small text-muted mb-2">
            Baseada no total anual (quartis). Safras com registros incompletos podem distorcer a classificação.
          </div>
          <div id="rankingBox"></div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-8">
        <div class="glass-card" id="cardChart">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">
              <i class="fa-solid fa-chart-line me-2 text-primary"></i><span id="chartTitle">Anual (Totais)</span>
            </div>
            <span class="badge bg-light text-dark border" id="chartLabel">Histórico</span>
          </div>
          <div class="chart-box">
            <canvas id="mainChart"></canvas>
          </div>
        </div>

        <div class="glass-card d-none" id="cardHeatmap">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold"><i class="fa-solid fa-calendar-days me-2 text-primary"></i>Calendário (por safra)</div>
            <small class="text-muted bg-light px-2 py-1 rounded">Nº = dia do mês</small>
          </div>
          <div id="heatmapContainer" class="heatmap-wrapper"></div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="glass-card" style="height: 640px; display:flex; flex-direction:column;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold"><i class="fa-solid fa-list me-2 text-primary"></i>Registros</div>
            <span class="small text-muted" id="tableHint"></span>
          </div>
          <div class="flex-grow-1 overflow-auto">
            <table class="table table-modern table-hover mb-0">
              <thead class="sticky-top">
                <tr>
                  <th>Data</th>
                  <th>Vol.</th>
                  <th>Safra</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
          <div class="pt-2 small text-muted">
            Dica: para manter consistência, registre sempre em mm e use a safra (ano) como referência.
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p class="mb-0">Desenvolvido por <strong>Murilo Feitosa</strong></p>
      <small>Fazenda Cacimbas &copy; 2026</small>
    </div>
  </footer>

  <!-- Modal: Adicionar registro -->
  <div class="modal fade" id="modalAdd" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold"><i class="fa-solid fa-plus me-2 text-primary"></i>Novo registro de chuva</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label fw-bold">Data</label>
              <input type="date" class="form-control" id="addDate">
            </div>
            <div class="col-6">
              <label class="form-label fw-bold">Volume (mm)</label>
              <input type="number" class="form-control" id="addValue" min="0" step="0.1" placeholder="Ex.: 12">
            </div>
            <div class="col-12">
              <label class="form-label fw-bold">Safra (Inverno)</label>
              <input type="text" class="form-control" id="addSeason" placeholder="Ex.: 2026" inputmode="numeric">
              <div class="form-text">
                Use o ano de referência da safra. Ex.: chuvas de fev/2026 → safra 2026.
              </div>
            </div>
          </div>
          <div class="alert alert-warning mt-3 mb-0 small">
            Este lançamento salva no seu navegador (localStorage). Para backup e migração, use Exportar CSV.
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-light border" data-bs-dismiss="modal" type="button">Cancelar</button>
          <button class="btn btn-primary fw-bold" type="button" onclick="addRecord()">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast simples (substitui alert em pontos críticos) -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
    <div id="appToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Mensagem</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ==========================================================
    // 1) DADOS BASE (mantidos) + NORMALIZAÇÃO
    // ==========================================================
    const rawDataBase = [
      // Totais anuais históricos
      { date: '2013-01-01', value: 312, season: '2013' },
      { date: '2014-01-01', value: 499, season: '2014' },
      { date: '2015-01-01', value: 478, season: '2015' },
      { date: '2016-01-01', value: 605, season: '2016' },
      { date: '2017-01-01', value: 352, season: '2017' },
      { date: '2018-01-01', value: 430, season: '2018' },
      { date: '2019-01-01', value: 712, season: '2019' },
      { date: '2020-01-01', value: 898, season: '2020' },
      { date: '2021-01-01', value: 609, season: '2021' },
      { date: '2022-01-01', value: 595, season: '2022' },

      // Safra 2024 (diário)
      { date: '2023-11-06', value: 6, season: '2024' },
      { date: '2023-11-28', value: 8, season: '2024' },
      { date: '2023-12-18', value: 9, season: '2024' },
      { date: '2023-12-20', value: 48, season: '2024' },
      { date: '2023-12-21', value: 10, season: '2024' },
      { date: '2024-01-12', value: 20, season: '2024' },
      { date: '2024-02-09', value: 9, season: '2024' },
      { date: '2024-02-11', value: 20, season: '2024' },
      { date: '2024-02-13', value: 11, season: '2024' },
      { date: '2024-02-18', value: 39, season: '2024' },
      { date: '2024-02-21', value: 59, season: '2024' },
      { date: '2024-02-27', value: 28, season: '2024' },
      { date: '2024-02-28', value: 30, season: '2024' },
      { date: '2024-03-01', value: 8, season: '2024' },
      { date: '2024-03-04', value: 8, season: '2024' },
      { date: '2024-03-05', value: 16, season: '2024' },
      { date: '2024-03-13', value: 19, season: '2024' },
      { date: '2024-03-27', value: 19, season: '2024' },
      { date: '2024-03-30', value: 21, season: '2024' },
      { date: '2024-03-31', value: 110, season: '2024' },
      { date: '2024-04-02', value: 11, season: '2024' },
      { date: '2024-04-03', value: 5, season: '2024' },
      { date: '2024-04-10', value: 32, season: '2024' },
      { date: '2024-04-11', value: 2, season: '2024' },
      { date: '2024-04-12', value: 14, season: '2024' },
      { date: '2024-04-14', value: 3, season: '2024' },
      { date: '2024-04-15', value: 11, season: '2024' },
      { date: '2024-04-16', value: 6, season: '2024' },
      { date: '2024-04-20', value: 5, season: '2024' },
      { date: '2024-04-21', value: 23, season: '2024' },
      { date: '2024-04-22', value: 11, season: '2024' },

      // Safra 2025 (diário)
      { date: '2024-12-03', value: 40, season: '2025' },
      { date: '2025-01-13', value: 14, season: '2025' },
      { date: '2025-01-14', value: 105, season: '2025' },
      { date: '2025-01-15', value: 34, season: '2025' },
      { date: '2025-01-20', value: 95, season: '2025' },
      { date: '2025-01-23', value: 10, season: '2025' },
      { date: '2025-02-17', value: 11, season: '2025' },
      { date: '2025-02-19', value: 22, season: '2025' },
      { date: '2025-02-24', value: 34, season: '2025' },
      { date: '2025-02-28', value: 50, season: '2025' },
      { date: '2025-03-01', value: 56, season: '2025' },
      { date: '2025-03-03', value: 10, season: '2025' },
      { date: '2025-03-04', value: 30, season: '2025' },
      { date: '2025-03-06', value: 6, season: '2025' },
      { date: '2025-03-07', value: 100, season: '2025' },
      { date: '2025-03-08', value: 24, season: '2025' },
      { date: '2025-03-11', value: 5, season: '2025' },
      { date: '2025-03-17', value: 9, season: '2025' },
      { date: '2025-03-18', value: 77, season: '2025' },
      { date: '2025-03-22', value: 9, season: '2025' },
      { date: '2025-03-28', value: 40, season: '2025' },
      { date: '2025-04-02', value: 10, season: '2025' },
      { date: '2025-04-22', value: 19, season: '2025' },
      { date: '2025-05-05', value: 11, season: '2025' },
      { date: '2025-05-10', value: 10, season: '2025' },
      { date: '2025-05-21', value: 9, season: '2025' },

      // Safra 2026 (diário)
      { date: '2025-10-21', value: 20, season: '2026' },
      { date: '2025-12-22', value: 55, season: '2026' },
      { date: '2025-12-23', value: 18, season: '2026' },
      { date: '2026-01-21', value: 7, season: '2026' },
      { date: '2026-01-27', value: 59, season: '2026' },
      { date: '2026-01-29', value: 40, season: '2026' },
      { date: '2026-02-05', value: 20, season: '2026' },
      { date: '2026-02-07', value: 8, season: '2026' },
      { date: '2026-02-08', value: 10, season: '2026' },
      { date: '2026-02-11', value: 5, season: '2026' },
      { date: '2026-02-12', value: 20, season: '2026' },
      { date: '2026-02-15', value: 4, season: '2026' },
      { date: '2026-02-16', value: 38, season: '2026' },
      { date: '2026-02-18', value: 15, season: '2026' },
      { date: '2026-02-27', value: 24, season: '2026' }
    ];

    // ==========================================================
    // 2) CONFIGURAÇÃO GERAL / ESTADO
    // ==========================================================
    const monthNames = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
    const LS_KEY = "cacimbas_rain_v2"; // versão nova para evitar conflito com versões antigas

    const state = {
      viewMode: "annual",    // annual | monthly | daily | calendar
      selectedSeasons: [],   // até 4
      data: []               // dados normalizados e consolidados
    };

    let chartMain = null;

    document.getElementById("currentDate").textContent =
      new Date().toLocaleDateString("pt-BR", { weekday:"long", day:"numeric", month:"long", year:"numeric" });

    function showToast(message){
      const el = document.getElementById("appToast");
      const msg = document.getElementById("toastMsg");
      msg.textContent = message;
      const toast = bootstrap.Toast.getOrCreateInstance(el, { delay: 2500 });
      toast.show();
    }

    function toggleRadar(){
      const box = document.getElementById("radarBox");
      box.style.display = (box.style.display === "none" || box.style.display === "") ? "block" : "none";
    }

    // ==========================================================
    // 3) NORMALIZAÇÃO, CONSOLIDAÇÃO E STORAGE
    // ==========================================================
    function normalizeBaseData(list){
      // Regra: registros do histórico anual (2013-2022) com data 01/01 viram annual_total.
      // Os demais viram daily.
      return list.map(d => {
        const year = Number(d.season);
        const kind = (year <= 2022 && String(d.date).endsWith("-01-01")) ? "annual_total" : "daily";
        return {
          date: String(d.date),
          value: Number(d.value) || 0,
          season: String(d.season),
          kind
        };
      });
    }

    function isValidISODate(dateStr){
      if(!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return false;
      const dt = new Date(dateStr + "T00:00:00");
      return !Number.isNaN(dt.getTime());
    }

    function loadExtra(){
      const saved = localStorage.getItem(LS_KEY);
      if(!saved) return [];
      try{
        const extra = JSON.parse(saved);
        if(!Array.isArray(extra)) return [];
        return extra
          .map(r => ({
            date: String(r.date),
            value: Number(r.value) || 0,
            season: String(r.season),
            kind: "daily"
          }))
          .filter(r => isValidISODate(r.date) && r.season);
      }catch{
        return [];
      }
    }

    function saveExtra(list){
      localStorage.setItem(LS_KEY, JSON.stringify(list));
    }

    function loadData(){
      const base = normalizeBaseData(rawDataBase);
      const extra = loadExtra();
      const merged = [...base, ...extra];

      // Consolidação: evita duplicidade por (season, date, kind).
      // Se houver duplicados daily na mesma data e safra, soma volumes.
      const key = (r) => `${r.season}__${r.date}__${r.kind}`;
      const map = new Map();

      merged.forEach(r=>{
        const k = key(r);
        if(!map.has(k)){
          map.set(k, {...r});
          return;
        }
        const existing = map.get(k);
        if(r.kind === "daily"){
          existing.value += r.value;
          map.set(k, existing);
        }else{
          // annual_total: mantém o maior, por segurança
          existing.value = Math.max(existing.value, r.value);
          map.set(k, existing);
        }
      });

      return Array.from(map.values());
    }

    function addRecord(){
      const date = document.getElementById("addDate").value;
      const value = Number(document.getElementById("addValue").value);
      const season = document.getElementById("addSeason").value.trim();

      if(!date || !isValidISODate(date)){
        showToast("Informe uma data válida.");
        return;
      }
      if(!season || !/^\d{4}$/.test(season)){
        showToast("Informe a safra no formato AAAA (ex.: 2026).");
        return;
      }
      if(Number.isNaN(value) || value < 0){
        showToast("Informe um volume (mm) válido.");
        return;
      }

      const extra = loadExtra();
      extra.push({ date, value, season });
      saveExtra(extra);

      state.data = loadData();
      rebuild();

      const modalEl = document.getElementById("modalAdd");
      const modal = bootstrap.Modal.getInstance(modalEl) || bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.hide();

      document.getElementById("addDate").value = "";
      document.getElementById("addValue").value = "";
      document.getElementById("addSeason").value = "";

      showToast("Registro salvo.");
    }

    // ==========================================================
    // 4) EXPORTAÇÃO/IMPORTAÇÃO CSV
    // ==========================================================
    function toCSV(rows){
      const header = ["date","value","season"];
      const lines = [header.join(",")];
      rows.forEach(r=>{
        const d = String(r.date);
        const v = String(Number(r.value) || 0);
        const s = String(r.season);
        lines.push([d,v,s].join(","));
      });
      return lines.join("\n");
    }

    function exportCSV(){
      const extra = loadExtra();
      if(extra.length === 0){
        showToast("Não há registros manuais para exportar.");
        return;
      }
      const csv = toCSV(extra);
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "fazenda_cacimbas_registros.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showToast("CSV exportado.");
    }

    function parseCSV(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      if(lines.length < 2) return [];
      const header = lines[0].split(",").map(h=>h.trim().toLowerCase());
      const idxDate = header.indexOf("date");
      const idxValue = header.indexOf("value");
      const idxSeason = header.indexOf("season");
      if(idxDate < 0 || idxValue < 0 || idxSeason < 0) return [];

      const out = [];
      for(let i=1;i<lines.length;i++){
        const parts = lines[i].split(",").map(p=>p.trim());
        const date = parts[idxDate];
        const value = Number(parts[idxValue]);
        const season = parts[idxSeason];

        if(!isValidISODate(date)) continue;
        if(!/^\d{4}$/.test(season)) continue;
        if(Number.isNaN(value) || value < 0) continue;

        out.push({ date, value, season });
      }
      return out;
    }

    function importCSV(event){
      const file = event.target.files && event.target.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        const text = String(reader.result || "");
        const rows = parseCSV(text);
        if(rows.length === 0){
          showToast("CSV inválido ou sem registros compatíveis.");
          return;
        }

        const current = loadExtra();
        const merged = [...current, ...rows];

        // Dedup por (season, date). Se duplicado, soma.
        const map = new Map();
        merged.forEach(r=>{
          const k = `${r.season}__${r.date}`;
          if(!map.has(k)){
            map.set(k, { ...r });
          }else{
            const ex = map.get(k);
            ex.value += r.value;
            map.set(k, ex);
          }
        });

        saveExtra(Array.from(map.values()));
        state.data = loadData();
        rebuild();
        showToast(`Importação concluída: ${rows.length} registros lidos.`);
      };
      reader.readAsText(file);

      // permite importar o mesmo arquivo novamente
      event.target.value = "";
    }

    // ==========================================================
    // 5) AGRUPAMENTOS E MÉTRICAS
    // ==========================================================
    function getSeasons(){
      return [...new Set(state.data.map(d => d.season))]
        .sort((a,b)=>Number(b)-Number(a));
    }

    function annualTotals(){
      // Preferência:
      // - Se existir annual_total para a safra: usa esse valor.
      // - Senão: soma daily.
      const bySeason = {};
      const hasAnnual = new Set();

      state.data.forEach(r=>{
        if(!bySeason[r.season]) bySeason[r.season] = { annual: 0, dailySum: 0 };
        if(r.kind === "annual_total"){
          bySeason[r.season].annual += r.value;
          hasAnnual.add(r.season);
        }else{
          bySeason[r.season].dailySum += r.value;
        }
      });

      return Object.keys(bySeason)
        .map(season=>{
          const total = hasAnnual.has(season) ? bySeason[season].annual : bySeason[season].dailySum;
          return { season, total: Math.round(total) };
        })
        .sort((a,b)=>Number(a.season)-Number(b.season));
    }

    function quartiles(nums){
      const a = [...nums].sort((x,y)=>x-y);
      const q = (p)=>{
        const pos = (a.length - 1) * p;
        const base = Math.floor(pos);
        const rest = pos - base;
        if(a[base+1] === undefined) return a[base];
        return a[base] + rest * (a[base+1] - a[base]);
      };
      return { q1: q(0.25), q3: q(0.75) };
    }

    function classifySeasons(){
      const totals = annualTotals();
      const values = totals.map(t=>t.total);

      if(values.length < 4){
        const sorted = [...values].sort((a,b)=>a-b);
        const median = sorted[Math.floor(sorted.length/2)] || 0;
        const map = new Map();
        totals.forEach(t=>{
          map.set(t.season, t.total >= median ? "good" : "bad");
        });
        return { map, q1: null, q3: null };
      }

      const { q1, q3 } = quartiles(values);
      const map = new Map();
      totals.forEach(t=>{
        let cls = "mid";
        if(t.total <= q1) cls = "bad";
        if(t.total >= q3) cls = "good";
        map.set(t.season, cls);
      });
      return { map, q1, q3 };
    }

    function dailyBySeason(season){
      return state.data
        .filter(r => r.kind === "daily" && r.season === season)
        .map(r => ({...r, dt: new Date(r.date + "T00:00:00")}))
        .sort((a,b)=>a.dt-b.dt);
    }

    function monthlyTotalsForSeason(season){
      const arr = dailyBySeason(season);
      const months = Array(12).fill(0);
      arr.forEach(r=>{
        months[r.dt.getMonth()] += r.value;
      });
      return months.map(v=>Math.round(v));
    }

    // ==========================================================
    // 6) UI: SAFRAS (CHIPS) E PRESETS
    // ==========================================================
    function renderSeasonChips(){
      const seasons = getSeasons();
      const box = document.getElementById("seasonChips");
      box.innerHTML = "";

      seasons.forEach(season=>{
        const active = state.selectedSeasons.includes(season);
        const el = document.createElement("button");
        el.className = active ? "chip active" : "chip";
        el.type = "button";
        el.textContent = season;
        el.onclick = () => toggleSeason(season);
        box.appendChild(el);
      });
    }

    function toggleSeason(season){
      const idx = state.selectedSeasons.indexOf(season);
      if(idx >= 0){
        state.selectedSeasons.splice(idx, 1);
      }else{
        if(state.selectedSeasons.length >= 4){
          showToast("Selecione no máximo 4 safras para comparação.");
          return;
        }
        state.selectedSeasons.push(season);
      }
      rebuild();
    }

    function selectPreset(type){
      const totals = annualTotals();
      if(totals.length === 0) return;

      if(type === "clear"){
        state.selectedSeasons = [];
        rebuild();
        return;
      }

      if(type === "last"){
        state.selectedSeasons = [totals[totals.length-1].season];
        rebuild();
        return;
      }

      if(type === "best"){
        const best = [...totals].sort((a,b)=>b.total-a.total)[0].season;
        state.selectedSeasons = [best];
        rebuild();
        return;
      }

      if(type === "worst"){
        const worst = [...totals].sort((a,b)=>a.total-b.total)[0].season;
        state.selectedSeasons = [worst];
        rebuild();
        return;
      }
    }

    // ==========================================================
    // 7) KPI + RANKING
    // ==========================================================
    function renderKPIs(){
      const totals = annualTotals();
      const { map } = classifySeasons();

      const best = totals.length ? [...totals].sort((a,b)=>b.total-a.total)[0] : null;
      const worst = totals.length ? [...totals].sort((a,b)=>a.total-b.total)[0] : null;

      let selTotal = 0;
      let selDays = 0;
      const seasons = state.selectedSeasons.length ? state.selectedSeasons : [];

      seasons.forEach(s=>{
        const t = totals.find(x=>x.season===s);
        if(t) selTotal += t.total;
        selDays += dailyBySeason(s).length;
      });

      const kpiBox = document.getElementById("kpiContainer");
      kpiBox.innerHTML = `
        <div class="col-6">
          <div class="p-2 border rounded bg-white h-100">
            <div class="kpi-label">Melhor safra</div>
            <div class="kpi-value">${best ? best.total : 0} <small class="fs-6 text-muted">mm</small></div>
            <div class="kpi-sub">${best ? "Safra " + best.season : "-"}</div>
          </div>
        </div>
        <div class="col-6">
          <div class="p-2 border rounded bg-white h-100">
            <div class="kpi-label">Pior safra</div>
            <div class="kpi-value" style="color: var(--danger-red)">${worst ? worst.total : 0} <small class="fs-6 text-muted">mm</small></div>
            <div class="kpi-sub">${worst ? "Safra " + worst.season : "-"}</div>
          </div>
        </div>
        <div class="col-12">
          <div class="p-2 border rounded bg-white">
            <div class="kpi-label">Seleção atual</div>
            <div class="d-flex justify-content-between flex-wrap gap-2">
              <div><span class="fw-bold">${seasons.length ? seasons.join(", ") : "Nenhuma"}</span></div>
              <div class="text-muted">Total: <span class="fw-bold">${Math.round(selTotal)}</span> mm | Dias: <span class="fw-bold">${selDays}</span></div>
            </div>
          </div>
        </div>
      `;

      const rankBox = document.getElementById("rankingBox");
      const sorted = [...totals].sort((a,b)=>b.total-a.total);
      const top = sorted.slice(0,5);
      const bot = [...sorted].reverse().slice(0,5);

      function badgeFor(season){
        const cls = map.get(season) || "mid";
        if(cls==="good") return `<span class="badge badge-good">Bom</span>`;
        if(cls==="bad") return `<span class="badge badge-bad">Ruim</span>`;
        return `<span class="badge badge-mid">Regular</span>`;
      }

      function row(x, idx){
        return `
          <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2 bg-white">
            <div class="fw-bold">${idx+1}. Safra ${x.season}</div>
            <div class="d-flex align-items-center gap-2">
              ${badgeFor(x.season)}
              <span class="fw-bold">${x.total} mm</span>
            </div>
          </div>
        `;
      }

      rankBox.innerHTML = `
        <div class="fw-bold mb-2">Top 5</div>
        ${top.length ? top.map((x,i)=>row(x,i)).join("") : `<div class="text-muted">Sem dados suficientes.</div>`}
        <div class="fw-bold mt-3 mb-2">Bottom 5</div>
        ${bot.length ? bot.map((x,i)=>row(x,i)).join("") : `<div class="text-muted">Sem dados suficientes.</div>`}
      `;
    }

    // ==========================================================
    // 8) GRÁFICOS (Chart.js)
    // ==========================================================
    function destroyChart(){
      if(chartMain){
        chartMain.destroy();
        chartMain = null;
      }
    }

    function chartBaseOptions(){
      return {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 250 },
        interaction: { mode: "index", intersect: false }
      };
    }

    function renderAnnualChart(){
      const totals = annualTotals();
      const { map, q1, q3 } = classifySeasons();

      const labels = totals.map(t=>t.season);
      const values = totals.map(t=>t.total);

      document.getElementById("chartTitle").textContent = "Anual (Totais)";
      document.getElementById("chartLabel").textContent = "Comparação por safra (mm)";
      document.getElementById("modeHint").textContent = "Recomendado para identificar anos bons/ruins e tendência histórica.";

      destroyChart();

      const selected = new Set(state.selectedSeasons);

      chartMain = new Chart(document.getElementById("mainChart"),{
        type:"line",
        data:{
          labels,
          datasets:[
            {
              label:"Total anual (mm)",
              data: values,
              borderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6,
              borderColor: "#2563eb",
              backgroundColor: "rgba(37, 99, 235, 0.12)",
              fill: true,
              segment: {
                borderColor: (ctx) => {
                  const season = labels[ctx.p0DataIndex];
                  const cls = map.get(season) || "mid";
                  if(cls==="good") return "#10b981";
                  if(cls==="bad") return "#ef4444";
                  return "#2563eb";
                }
              },
              pointBackgroundColor: (ctx) => {
                const season = labels[ctx.dataIndex];
                const cls = map.get(season) || "mid";
                if(cls==="good") return "#10b981";
                if(cls==="bad") return "#ef4444";
                return "#2563eb";
              },
              pointBorderColor: (ctx) => selected.has(labels[ctx.dataIndex]) ? "#0f172a" : "#ffffff",
              pointBorderWidth: (ctx) => selected.has(labels[ctx.dataIndex]) ? 3 : 1
            }
          ]
        },
        options:{
          ...chartBaseOptions(),
          plugins:{
            legend:{ display:false },
            tooltip:{
              callbacks:{
                afterLabel: (ctx)=>{
                  const season = ctx.label;
                  const cls = map.get(season) || "mid";
                  const tag = cls==="good" ? "Bom" : (cls==="bad" ? "Ruim" : "Regular");
                  const extra = (q1!=null && q3!=null) ? ` (Q1≈${q1.toFixed(0)} | Q3≈${q3.toFixed(0)})` : "";
                  const sel = selected.has(season) ? " [Selecionada]" : "";
                  return `Classificação: ${tag}${extra}${sel}`;
                }
              }
            }
          },
          scales:{
            y:{ beginAtZero:true, title:{ display:true, text:"mm" } }
          }
        }
      });
    }

    function renderMonthlyCompareChart(){
      const seasons = state.selectedSeasons.length ? state.selectedSeasons : [];

      document.getElementById("chartTitle").textContent = "Mensal (Comparativo)";
      document.getElementById("chartLabel").textContent = seasons.length ? ("Safras: " + seasons.join(", ")) : "Selecione até 4 safras";
      document.getElementById("modeHint").textContent = "Comparação por mês. Útil para entender o ciclo (pico e distribuição).";

      destroyChart();

      if(seasons.length === 0){
        chartMain = new Chart(document.getElementById("mainChart"),{
          type:"bar",
          data:{ labels: monthNames, datasets:[{ label:"Selecione safras", data: Array(12).fill(0), backgroundColor:"#e2e8f0", borderRadius: 6 }] },
          options:{ ...chartBaseOptions(), plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
        });
        return;
      }

      const palette = ["#2563eb", "#10b981", "#f59e0b", "#ef4444"];
      const datasets = seasons.map((s, idx)=>({
        label: "Safra " + s,
        data: monthlyTotalsForSeason(s),
        backgroundColor: palette[idx % palette.length],
        borderRadius: 6
      }));

      chartMain = new Chart(document.getElementById("mainChart"),{
        type:"bar",
        data:{ labels: monthNames, datasets },
        options:{
          ...chartBaseOptions(),
          plugins:{ legend:{ position:"bottom" } },
          scales:{ y:{ beginAtZero:true, title:{ display:true, text:"mm" } } }
        }
      });
    }

    function renderDailyChart(){
      const season = state.selectedSeasons[0];

      document.getElementById("chartTitle").textContent = "Diário + Acumulado";
      document.getElementById("modeHint").textContent = "Visão operacional da safra selecionada. Mostra eventos e progressão do acumulado.";

      destroyChart();

      if(!season){
        document.getElementById("chartLabel").textContent = "Selecione 1 safra";
        chartMain = new Chart(document.getElementById("mainChart"),{
          type:"bar",
          data:{ labels:["-"], datasets:[{ label:"Selecione 1 safra", data:[0], backgroundColor:"#e2e8f0", borderRadius: 6 }] },
          options:{ ...chartBaseOptions(), plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
        });
        return;
      }

      const arr = dailyBySeason(season);
      document.getElementById("chartLabel").textContent = "Safra " + season + " (eventos diários)";

      if(arr.length === 0){
        chartMain = new Chart(document.getElementById("mainChart"),{
          type:"bar",
          data:{ labels:["Sem registros"], datasets:[{ label:"Chuva (mm)", data:[0], backgroundColor:"#e2e8f0", borderRadius: 6 }] },
          options:{ ...chartBaseOptions(), plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
        });
        return;
      }

      const labels = arr.map(r=>{
        const d = r.dt;
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        return `${dd}/${mm}`;
      });

      const values = arr.map(r=>Math.round(r.value));
      let acc = 0;
      const acum = values.map(v => (acc += v));

      chartMain = new Chart(document.getElementById("mainChart"),{
        type:"bar",
        data:{
          labels,
          datasets:[
            { label:"Chuva (mm)", data: values, backgroundColor:"#2563eb", borderRadius: 4, yAxisID:"y" },
            { type:"line", label:"Acumulado", data: acum, borderColor:"#10b981", borderWidth: 2, pointRadius: 0, tension: 0.25, yAxisID:"y1" }
          ]
        },
        options:{
          ...chartBaseOptions(),
          plugins:{ legend:{ position:"bottom" } },
          scales:{
            x:{ ticks:{ maxRotation:0, minRotation:0, autoSkip: true, maxTicksLimit: 12 } },
            y:{ beginAtZero:true, position:"left", title:{ display:true, text:"mm (dia)" } },
            y1:{ beginAtZero:true, position:"right", grid:{ drawOnChartArea:false }, title:{ display:true, text:"mm (acum.)" } }
          }
        }
      });
    }

    // ==========================================================
    // 9) HEATMAP + TABELA
    // ==========================================================
    function renderHeatmap(){
      const season = state.selectedSeasons[0];
      const card = document.getElementById("cardHeatmap");
      const container = document.getElementById("heatmapContainer");
      container.innerHTML = "";

      card.classList.remove("d-none");

      if(!season){
        container.innerHTML = `<div class="text-muted">Selecione 1 safra para visualizar o calendário.</div>`;
        return;
      }

      const dados = dailyBySeason(season);
      if(dados.length === 0){
        container.innerHTML = `<div class="text-muted">Sem registros diários para a safra ${season}.</div>`;
        return;
      }

      // Agrupa por mês/ano
      const grouped = {};
      dados.forEach(d=>{
        const key = `${d.dt.getFullYear()}-${d.dt.getMonth()}`;
        if(!grouped[key]){
          grouped[key] = { year: d.dt.getFullYear(), month: d.dt.getMonth(), days: [] };
        }
        grouped[key].days.push(d);
      });

      const blocks = Object.values(grouped).sort((a,b)=>{
        if(a.year !== b.year) return a.year - b.year;
        return a.month - b.month;
      });

      blocks.forEach(b=>{
        b.days.sort((x,y)=> x.dt - y.dt);

        let daysHtml = "";
        b.days.forEach(day=>{
          const v = Number(day.value) || 0;
          let lvl = "lvl-1";
          if(v === 0) lvl = "lvl-0";
          if(v > 20) lvl = "lvl-2";
          if(v > 50) lvl = "lvl-3";
          if(v > 90) lvl = "lvl-4";
          const title = `${day.dt.toLocaleDateString("pt-BR")}: ${Math.round(v)} mm`;
          daysHtml += `<div class="rain-day ${lvl}" title="${title}">${day.dt.getDate()}</div>`;
        });

        container.innerHTML += `
          <div class="month-block">
            <div class="month-title">${monthNames[b.month]} ${b.year}</div>
            <div class="days-grid">${daysHtml}</div>
          </div>
        `;
      });
    }

    function renderTable(){
      const hint = document.getElementById("tableHint");
      let arr;

      if(state.selectedSeasons.length){
        const set = new Set(state.selectedSeasons);
        arr = state.data.filter(r => r.kind==="daily" && set.has(r.season));
        hint.textContent = "Filtro: seleção";
      }else{
        arr = state.data.filter(r => r.kind==="daily");
        hint.textContent = "Filtro: todos";
      }

      arr = arr.sort((a,b)=> new Date(b.date + "T00:00:00") - new Date(a.date + "T00:00:00"))
               .slice(0,120);

      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      arr.forEach(d=>{
        tbody.innerHTML += `
          <tr>
            <td>${new Date(d.date + "T00:00:00").toLocaleDateString("pt-BR")}</td>
            <td><strong>${Math.round(d.value)} mm</strong></td>
            <td><span class="badge-safra">${d.season}</span></td>
          </tr>
        `;
      });
    }

    // ==========================================================
    // 10) VIEW MODE (controle de cards) + RENDER
    // ==========================================================
    function setCardsForMode(mode){
      const cardHeatmap = document.getElementById("cardHeatmap");
      const cardChart = document.getElementById("cardChart");

      // padrão
      cardChart.classList.remove("d-none");
      cardHeatmap.classList.add("d-none");

      if(mode === "calendar"){
        // exibe também o heatmap
        cardHeatmap.classList.remove("d-none");
      }
    }

    function renderByMode(){
      setCardsForMode(state.viewMode);

      if(state.viewMode === "annual"){
        renderAnnualChart();
      }else if(state.viewMode === "monthly"){
        renderMonthlyCompareChart();
      }else if(state.viewMode === "daily"){
        renderDailyChart();
      }else if(state.viewMode === "calendar"){
        // no modo calendário, mantém o gráfico diário como contexto (acumulado) e mostra o heatmap
        renderDailyChart();
        renderHeatmap();
        document.getElementById("chartTitle").textContent = "Calendário + Contexto Diário";
        document.getElementById("chartLabel").textContent = state.selectedSeasons[0] ? ("Safra " + state.selectedSeasons[0]) : "Safra não selecionada";
        document.getElementById("modeHint").textContent = "Heatmap da safra e gráfico diário/acumulado como apoio.";
      }
    }

    // ==========================================================
    // 11) REBUILD (ponto único para manter tudo consistente)
    // ==========================================================
    function rebuild(){
      renderSeasonChips();
      renderKPIs();
      renderByMode();
      renderTable();

      const hint = document.getElementById("modeHint");
      if(state.viewMode === "daily" || state.viewMode === "calendar"){
        if(state.selectedSeasons.length === 0) hint.textContent = "Selecione 1 safra para esta visão.";
      }else if(state.viewMode === "monthly"){
        if(state.selectedSeasons.length === 0) hint.textContent = "Selecione até 4 safras para comparar mês a mês.";
      }
    }

    // ==========================================================
    // 12) INIT (corrigido: não depende de ids virarem variáveis globais)
    // ==========================================================
    window.onload = () => {
      state.data = loadData();

      // seleção inicial: última safra disponível
      const totals = annualTotals();
      if(totals.length){
        state.selectedSeasons = [totals[totals.length-1].season];
      }

      // listeners de modo (sem variável global)
      const elModeAnnual   = document.getElementById("modeAnnual");
      const elModeMonthly  = document.getElementById("modeMonthly");
      const elModeDaily    = document.getElementById("modeDaily");
      const elModeCalendar = document.getElementById("modeCalendar");

      elModeAnnual.addEventListener("change", () => {
        if(elModeAnnual.checked){
          state.viewMode = "annual";
          rebuild();
        }
      });

      elModeMonthly.addEventListener("change", () => {
        if(elModeMonthly.checked){
          state.viewMode = "monthly";
          rebuild();
        }
      });

      elModeDaily.addEventListener("change", () => {
        if(elModeDaily.checked){
          state.viewMode = "daily";
          rebuild();
        }
      });

      elModeCalendar.addEventListener("change", () => {
        if(elModeCalendar.checked){
          state.viewMode = "calendar";
          rebuild();
        }
      });

      rebuild();
    };
  </script>
</body>
</html>
```
