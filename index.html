<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plúvio - Fazenda Cacimbas</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #0d6efd;
            --bg-color: #f0f2f5;
        }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', system-ui, sans-serif; color: #333; }
        
        /* HEADER */
        .brand-header {
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px 0;
            border-bottom: 1px solid #dce1e6;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        .logo-img {
            max-height: 120px; 
            width: auto;
            border-radius: 50%; /* Deixa a logo redonda se for quadrada */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* CARDS */
        .kpi-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
            height: 100%;
            background: white;
            transition: transform 0.2s;
        }
        .kpi-card:hover { transform: translateY(-2px); }
        .card-header-custom {
            background: white;
            border-bottom: 1px solid #f0f0f0;
            padding: 15px 20px;
            font-weight: 700;
            color: #2c3e50;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* NOVO MAPA DE CALOR (Organizado por Mês) */
        .heatmap-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .month-block {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            background: #fff;
            flex: 1 1 200px; /* Responsivo */
            min-width: 180px;
        }
        .month-title {
            font-size: 0.85em;
            font-weight: bold;
            color: #555;
            margin-bottom: 8px;
            text-transform: uppercase;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 4px;
        }
        .days-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .rain-day {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .rain-day:hover { transform: scale(1.1); z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* Cores de Intensidade */
        .lvl-1 { background-color: #a5d8ff; color: #004085; } /* Fraca */
        .lvl-2 { background-color: #4dabf7; } /* Média */
        .lvl-3 { background-color: #1c7ed6; } /* Forte */
        .lvl-4 { background-color: #003e6b; border: 2px solid #ffd43b; } /* Tempestade */

        /* TABELA */
        .table-custom th { background-color: #f8f9fa; font-size: 0.8em; text-transform: uppercase; }
        .table-custom tr:hover { background-color: #f8f9fa; }

    </style>
</head>
<body>

<div class="brand-header text-center">
    <div class="container">
        <img src="https://cdn-icons-png.flaticon.com/512/2830/2830227.png" alt="Logo" class="logo-img mb-3">
        
        <h3 class="fw-bold text-dark mb-0">Fazenda Cacimbas</h3>
        <p class="text-muted mb-0">Sistema Plúvio | Monitoramento Inteligente</p>
        <span class="badge bg-light text-secondary border mt-2" id="display-date"></span>
    </div>
</div>

<div class="container pb-5">

    <div class="row g-4 mb-4" id="season-cards">
        </div>

    <div class="row g-4">
        <div class="col-lg-8">
            
            <div class="kpi-card mb-4">
                <div class="card-header-custom">
                    <span><i class="fas fa-chart-line me-2"></i>Evolução & Acumulado</span>
                    <span class="badge bg-primary bg-opacity-10 text-primary">Histórico</span>
                </div>
                <div class="card-body">
                    <canvas id="comboChart" height="130"></canvas>
                </div>
            </div>

            <div class="kpi-card">
                <div class="card-header-custom">
                    <span><i class="fas fa-calendar-alt me-2"></i>Calendário de Chuvas</span>
                    <small class="text-muted">Dias com registro</small>
                </div>
                
                <div class="d-flex justify-content-end px-3 py-2 gap-3 small bg-light border-bottom">
                    <span class="d-flex align-items-center gap-1"><div style="width:12px;height:12px;background:#a5d8ff;border-radius:2px"></div> Fraca</span>
                    <span class="d-flex align-items-center gap-1"><div style="width:12px;height:12px;background:#4dabf7;border-radius:2px"></div> Média</span>
                    <span class="d-flex align-items-center gap-1"><div style="width:12px;height:12px;background:#1c7ed6;border-radius:2px"></div> Forte</span>
                    <span class="d-flex align-items-center gap-1"><div style="width:12px;height:12px;background:#003e6b;border:1px solid #ffd43b;border-radius:2px"></div> Extrema</span>
                </div>

                <div id="heatmap-container" class="heatmap-wrapper">
                    </div>
            </div>
        </div>

        <div class="col-lg-4">
            
            <div class="kpi-card mb-4">
                <div class="card-header-custom">
                    <span><i class="fas fa-bullseye me-2"></i>Padrão da Região</span>
                </div>
                <div class="card-body text-center">
                    <canvas id="avgChart" height="220"></canvas>
                    <small class="text-muted d-block mt-2">Comparativo da média histórica mensal</small>
                </div>
            </div>

            <div class="kpi-card" style="height: 500px; display: flex; flex-direction: column;">
                <div class="card-header-custom">
                    <span><i class="fas fa-list me-2"></i>Últimos Registros</span>
                </div>
                <div class="card-body p-0" style="overflow-y: auto;">
                    <table class="table table-custom mb-0 text-center align-middle">
                        <thead class="sticky-top bg-white border-bottom shadow-sm">
                            <tr>
                                <th>Data</th>
                                <th>Volume</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. DADOS (Histórico Completo) ---
    const rawData = [
        // INVERNO 2024
        { date: '2023-11-06', value: 6, season: '2024' },
        { date: '2023-11-28', value: 8, season: '2024' },
        { date: '2023-12-18', value: 9, season: '2024' },
        { date: '2023-12-20', value: 48, season: '2024' },
        { date: '2023-12-21', value: 10, season: '2024' },
        { date: '2024-01-12', value: 20, season: '2024' },
        { date: '2024-02-09', value: 9, season: '2024' },
        { date: '2024-02-11', value: 20, season: '2024' },
        { date: '2024-02-13', value: 11, season: '2024' },
        { date: '2024-02-18', value: 39, season: '2024' },
        { date: '2024-02-21', value: 59, season: '2024' },
        { date: '2024-02-27', value: 28, season: '2024' },
        { date: '2024-02-28', value: 30, season: '2024' },
        { date: '2024-03-01', value: 8, season: '2024' },
        { date: '2024-03-04', value: 8, season: '2024' },
        { date: '2024-03-05', value: 16, season: '2024' },
        { date: '2024-03-13', value: 19, season: '2024' },
        { date: '2024-03-27', value: 19, season: '2024' },
        { date: '2024-03-30', value: 21, season: '2024' },
        { date: '2024-03-31', value: 110, season: '2024' },
        { date: '2024-04-02', value: 11, season: '2024' },
        { date: '2024-04-03', value: 5, season: '2024' },
        { date: '2024-04-10', value: 32, season: '2024' },
        { date: '2024-04-11', value: 2, season: '2024' },
        { date: '2024-04-12', value: 14, season: '2024' },
        { date: '2024-04-14', value: 3, season: '2024' },
        { date: '2024-04-15', value: 11, season: '2024' },
        { date: '2024-04-16', value: 6, season: '2024' },
        { date: '2024-04-20', value: 5, season: '2024' },
        { date: '2024-04-21', value: 23, season: '2024' },
        { date: '2024-04-22', value: 11, season: '2024' },

        // INVERNO 2025
        { date: '2024-12-03', value: 40, season: '2025' },
        { date: '2025-01-13', value: 14, season: '2025' },
        { date: '2025-01-14', value: 105, season: '2025' },
        { date: '2025-01-15', value: 34, season: '2025' },
        { date: '2025-01-20', value: 95, season: '2025' },
        { date: '2025-01-23', value: 10, season: '2025' },
        { date: '2025-02-17', value: 11, season: '2025' },
        { date: '2025-02-19', value: 22, season: '2025' },
        { date: '2025-02-24', value: 34, season: '2025' },
        { date: '2025-02-28', value: 50, season: '2025' },
        { date: '2025-03-01', value: 56, season: '2025' },
        { date: '2025-03-03', value: 10, season: '2025' },
        { date: '2025-03-04', value: 30, season: '2025' },
        { date: '2025-03-06', value: 6, season: '2025' },
        { date: '2025-03-07', value: 100, season: '2025' },
        { date: '2025-03-08', value: 24, season: '2025' },
        { date: '2025-03-11', value: 5, season: '2025' },
        { date: '2025-03-17', value: 9, season: '2025' },
        { date: '2025-03-18', value: 77, season: '2025' },
        { date: '2025-03-22', value: 9, season: '2025' },
        { date: '2025-03-28', value: 40, season: '2025' },
        { date: '2025-04-02', value: 10, season: '2025' },
        { date: '2025-04-22', value: 19, season: '2025' },
        { date: '2025-05-05', value: 11, season: '2025' },
        { date: '2025-05-10', value: 10, season: '2025' },
        { date: '2025-05-21', value: 9, season: '2025' },

        // INVERNO 2026
        { date: '2025-10-21', value: 20, season: '2026' },
        { date: '2025-12-22', value: 55, season: '2026' },
        { date: '2025-12-23', value: 18, season: '2026' },
        { date: '2026-01-21', value: 7, season: '2026' },
        { date: '2026-01-27', value: 59, season: '2026' },
        { date: '2026-01-29', value: 40, season: '2026' },
        { date: '2026-02-05', value: 20, season: '2026' },
        { date: '2026-02-07', value: 8, season: '2026' }
    ];

    const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    document.getElementById('display-date').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

    // Ordenação
    const sortedData = [...rawData].sort((a, b) => new Date(a.date) - new Date(b.date));
    const reverseData = [...rawData].sort((a, b) => new Date(b.date) - new Date(a.date));

    // --- 2. CÁLCULOS E LÓGICA ---

    // Acumulados e Gráfico
    let cumulativeSum = 0;
    const chartLabels = [];
    const dailyValues = [];
    const accumulatedValues = [];
    
    sortedData.forEach(d => {
        chartLabels.push(new Date(d.date).toLocaleDateString('pt-BR').slice(0,5)); 
        dailyValues.push(d.value);
        cumulativeSum += d.value;
        accumulatedValues.push(cumulativeSum);
    });

    // Totais por Inverno
    const seasonTotals = {};
    rawData.forEach(d => seasonTotals[d.season] = (seasonTotals[d.season] || 0) + d.value);

    // Média Histórica
    const monthlyTotals = {};
    rawData.forEach(d => {
        const key = `${new Date(d.date).getMonth()}-${new Date(d.date).getFullYear()}`;
        if (!monthlyTotals[key]) monthlyTotals[key] = { month: new Date(d.date).getMonth(), val: 0 };
        monthlyTotals[key].val += d.value;
    });
    
    const monthSums = Array(12).fill(0);
    const monthCounts = Array(12).fill(0);
    Object.values(monthlyTotals).forEach(m => {
        monthSums[m.month] += m.val;
        monthCounts[m.month] += 1;
    });
    const historicAverages = monthSums.map((sum, i) => monthCounts[i] ? Math.round(sum / monthCounts[i]) : 0);

    // --- 3. RENDERIZAÇÃO ---

    // A. Cards KPI (Invernos)
    const kpiContainer = document.getElementById('season-cards');
    Object.keys(seasonTotals).sort().reverse().forEach((season, index) => {
        const isLatest = index === 0;
        const borderClass = isLatest ? 'border-primary border-2' : 'border-light';
        const titleClass = isLatest ? 'text-primary' : 'text-secondary';
        
        kpiContainer.innerHTML += `
            <div class="col-md-6 col-lg-4">
                <div class="kpi-card p-3 text-center d-flex flex-column justify-content-center ${borderClass}">
                    <span class="text-uppercase small fw-bold text-muted mb-1">Inverno ${season}</span>
                    <h2 class="fw-bold mb-0 ${titleClass}">${seasonTotals[season]} <small class="fs-6 text-muted">mm</small></h2>
                </div>
            </div>
        `;
    });

    // B. Heatmap Inovador (Agrupado por Mês)
    const heatmapContainer = document.getElementById('heatmap-container');
    
    // Agrupar dados por Mês/Ano (Ex: "10-2025" -> Array de dias)
    const groupedByMonth = {};
    // Ordenar do mais recente para o antigo para leitura melhor
    [...sortedData].reverse().forEach(d => {
        const dateObj = new Date(d.date);
        const key = `${dateObj.getMonth()}-${dateObj.getFullYear()}`;
        if (!groupedByMonth[key]) {
            groupedByMonth[key] = {
                monthName: monthNames[dateObj.getMonth()],
                year: dateObj.getFullYear(),
                days: []
            };
        }
        groupedByMonth[key].days.push(d);
    });

    // Criar visual
    Object.values(groupedByMonth).forEach(group => {
        // Ordenar dias dentro do mês (1, 2, 3...)
        group.days.sort((a,b) => new Date(a.date) - new Date(b.date));

        const block = document.createElement('div');
        block.className = 'month-block';
        
        let daysHtml = '';
        group.days.forEach(day => {
            const val = day.value;
            let lvl = 'lvl-1';
            if (val > 15) lvl = 'lvl-2';
            if (val > 40) lvl = 'lvl-3';
            if (val > 80) lvl = 'lvl-4';
            
            daysHtml += `<div class="rain-day ${lvl}" title="${new Date(day.date).toLocaleDateString('pt-BR')}: ${val}mm">${new Date(day.date).getDate()}</div>`;
        });

        block.innerHTML = `
            <div class="month-title">${group.monthName} ${group.year}</div>
            <div class="days-grid">${daysHtml}</div>
        `;
        heatmapContainer.appendChild(block);
    });

    // C. Tabela
    const tableBody = document.getElementById('dataTableBody');
    reverseData.forEach(item => {
        const style = item.value >= 50 ? 'fw-bold text-primary' : '';
        tableBody.innerHTML += `
            <tr>
                <td>${new Date(item.date).toLocaleDateString('pt-BR')}</td>
                <td class="${style}">${item.value} mm</td>
            </tr>
        `;
    });

    // --- 4. GRÁFICOS ---
    
    // Combo Chart
    new Chart(document.getElementById('comboChart'), {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [
                {
                    label: 'Chuva do Dia',
                    data: dailyValues,
                    backgroundColor: '#0d6efd',
                    borderRadius: 2,
                    order: 2,
                    yAxisID: 'y'
                },
                {
                    type: 'line',
                    label: 'Acumulado',
                    data: accumulatedValues,
                    borderColor: '#198754',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1,
                    order: 1,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { display: true, position: 'top' } },
            scales: {
                x: { display: false },
                y: { display: true, position: 'left', title: { display: true, text: 'Chuva (mm)' } },
                y1: { display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Acumulado' } }
            }
        }
    });

    // Radar Chart
    new Chart(document.getElementById('avgChart'), {
        type: 'radar',
        data: {
            labels: monthNames,
            datasets: [{
                label: 'Média (mm)',
                data: historicAverages,
                backgroundColor: 'rgba(13, 110, 253, 0.2)',
                borderColor: '#0d6efd',
                pointBackgroundColor: '#fff',
                pointBorderColor: '#0d6efd',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { r: { angleLines: { display: true }, suggestedMin: 0, ticks: { display: false } } }
        }
    });

</script>
</body>
</html>
